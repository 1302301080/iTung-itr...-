define(function(require,exports,module){function a(a){if(a&&a.length>0)for(var b=0;b<a.length;b++){var c=a[b];c&&c.entitlement&&(!l.entitlement||l.entitlement.indexOf(c.entitlement)<0)&&a.splice(b,1)}}function b(){if(l){m=$("#ipo-filter-group"),n=$("#ipo-app-filter-group"),a(l.schema.ipo),a(l.schema.application);var b=t.getIndexByKey("0",l.schema.ipo,0),c=t.getIndexByKey("symbolName",l.schema.ipo),d=t.getIndexByKey("5",l.schema.ipo),e=t.getIndexByKey("applyAction",l.schema.ipo,-1),f=[];d>=0&&f.push([d,"zh-CN"===y?"asc":"desc"]),b>=0&&f.push([b,"asc"]),j=w.CreateDatatable({columnSchema:l.schema.ipo,order:f,aoColumnDefs:[{bSortable:!1,aTargets:[e]},{className:"extra-tooltip pointer",targets:[b]},{className:"ipo-symbol-name",targets:[c]}],textTagMapping:!1,i18nPrefix:"eipo"});var g=$(j.table().container());g.find(".dataTables_filter").appendTo($("#ipo-list-table-search-box-container"));var h={name:{i18n:"ipo-book-filter-status"},data:[{key:"ALL",value:messages.ALL.text},{key:"open",value:messages.eipo["ipo-status-open"].text},{key:"close",value:messages.eipo["ipo-status-close"].text}]};m.CreateDrowdownGroup(h);var d=t.getIndexByKey("5",l.schema.ipo);m.on("change",function(a,b){b="ALL"===b?"":messages.eipo["ipo-status-"+b].text,j.column(d).search(b,!1,!1,!1).draw(!1)});var i=t.getIndexByKey("changeAction",l.schema.application,-1),o=t.getIndexByKey("cancelAction",l.schema.application,-1),p=t.getIndexByKey("6",l.schema.application);k=x.CreateDatatable({columnSchema:l.schema.application,order:p>=0?[p,"desc"]:[],aoColumnDefs:[{bSortable:!1,aTargets:[i,o]},{className:"extra-tooltip pointer",targets:[p]}],textTagMapping:!1,i18nPrefix:"eipo"}),g=$(k.table().container()),g.find(".dataTables_filter").appendTo($("#ipo-app-table-search-box-container"));var q={name:{i18n:"ipo-book-filter-status"},data:[{key:"ALL",value:messages.ALL.text},{key:"1",value:messages.eipo.status_1.text},{key:"2",value:messages.eipo.status_2.text},{key:"3",value:messages.eipo.status_3.text},{key:"4",value:messages.eipo.status_4.text},{key:"5",value:messages.eipo.status_5.text},{key:"-1",value:messages.eipo["status_-1"].text}]};n.CreateDrowdownGroup(q);var r=t.getIndexByKey("5",l.schema.application);n.on("change",function(a,b){b="ALL"===b?"":messages.eipo["status_"+b].text,k.column(r).search(b,!1,!1,!1).draw(!1)}),t.upperCaseInput(),$("#eipo-container").translate("eipo"),setTimeout(function(){$(".loaders").remove(),$("body").removeClass("loader-container"),$($(".hide")[0]).removeClass("hide")},1e3)}}function c(a){var b=function(a){var b=!1,c=!1,d=a.data();if(d&&d._raw){if(d&&d._raw[5]&&d._raw[1502]&&moment(d._raw[1502],"YYYY-MM-DD").add(moment.duration(l.deadlineClosing))>moment()&&(b=!0,v&&r))for(var e in r)r[e]&&r[e][0]==d[0]&&"-1"!=r[e]._raw[5]&&(c=!0);b&&!c?$(a.node()).find("td .btn-apply").removeAttr("disabled").addClass("pointer").addClass("text-success").removeClass("text-muted"):$(a.node()).find("td .btn-apply").attr("disabled","disabled").removeClass("pointer").removeClass("text-success").addClass("text-muted"),d.enable=b,d.hasApplied=c}};if(a)b(a);else{var c=j.rows();if(c&&c[0])for(var d=0;d<c[0].length;d++){var a=j.row(c[0][d]);b(a)}}}function d(a){var b=function(a){if(a&&a.data()){var b=!0,c=!0,d=a.data();if(d&&d._raw){var e=d[0],f=d._raw[5];"1"!=f&&"6"!=f&&"7"!=f?(b=!1,c=!1):q[e]&&q[e].enable&&(!v||q[e].hasApplied)||(b=!1,c=!1),v&&(l.allowClientChange||(b=!1),l.allowClientCancel||(c=!1)),b?$(a.node()).find("td .btn-change").removeAttr("disabled").addClass("pointer").addClass("text-success").removeClass("text-muted"):$(a.node()).find("td .btn-change").attr("disabled","disabled").removeClass("pointer").removeClass("text-success").addClass("text-muted"),c?$(a.node()).find("td .btn-cancel").removeAttr("disabled").addClass("pointer").addClass("text-danger").removeClass("text-muted"):$(a.node()).find("td .btn-cancel").attr("disabled","disabled").removeClass("pointer").removeClass("text-danger").addClass("text-muted")}}};if(a)b(a);else{var c=k.rows();if(c&&c[0]&&c[0].length>0)for(var d=0;d<c[0].length;d++){var a=k.row([d]);b(a)}}}function e(){$("#account-exploer-btn").click(function(){s.popup({callback:function(a){filter_account.val(a)}})})}function f(a,b){a&&b&&o.showMessage({title:messages.eipo["ipo-apply-popup-title"].text,buttonNameList:["submit","close"],load:{url:"/eipo/apply?symbol={0}&announce={1}".format(a,b),callback:function(c){p.initApplicationForm({container:c.getModalBody(),configData:l,symbolCode:a,announceCode:b})}},callback:function(a,b){if(a&&b){var c=a.attr("id");"btn-submit"===c?p.add(function(a,c){b.close(),a?t.popupInformation(a):t.popupInformation({message:messages.eipo["message-apply-success"].text})}):b.close()}}})}function g(a){a&&o.showMessage({title:messages.eipo["ipo-change-popup-title"].text,buttonNameList:["submit","close"],load:{url:"/eipo/change?orderNo="+a,callback:function(a){p.initChangeOrderForm({container:a.getModalBody(),configData:l})}},callback:function(a,b){var c=a.attr("id");"btn-submit"===c?p.change(function(a,c){b.close(),a?t.popupInformation(a):t.popupInformation({message:messages.eipo["message-change-success"].text})}):b.close()}})}function h(a){a&&o.showMessage({title:messages.eipo["ipo-cancel-popup-title"].text,buttonNameList:["submit","close"],load:{url:"/eipo/cancel?orderNo="+a,callback:function(a){p.initCancelOrderForm({container:a.getModalBody(),configData:l})}},callback:function(a,b){var c=a.attr("id");"btn-submit"===c?p.cancel(function(a,c){b.close(),a?t.popupInformation(a):t.popupInformation({message:messages.eipo["message-cancel-success"].text})}):b.close()}})}function i(a){if(a){var b="",c="0"!=a[1505],d=Number(a[1506]);if(c&&d>0&&a[3]&&a[1601]){var e=a[1601]/a[3];b="{0}: {1};".format(messages.eipo["column-loan-ratio"].text,t.getMarginRatio(e,l.format.price,!0))}var f=a[5];6==f?b+=messages.eipo["ipo-remark-waiting-change"].text+";":7==f&&(b+=messages.eipo["ipo-remark-waiting-cancel"].text+";"),a[25]=b+(a[25]||"")}}require("datatables");var j,k,l,m,n,o=require("dialog"),p=require("eipo-application"),q={},r={},s=require("eipo-accountExploer"),t=require("eipo-utility"),u=(require("format"),require("eipo-socket")),v="1"==$("#login-type").val(),w=$("#ipo-list-table"),x=$("#application-list-table"),y=$("html").attr("lang");$.get("/eipo/message/config",function(a){l=a,s.init(l);var m=l.format;b(),u.subscribeIPOS(function(a){for(var b=0;b<a.length;b++){var d=a[b],e=d[0];if(!e)return;d.DT_RowId="symbol-{0}-{1}".format(e,d[1599]),d[1507]=t.getMarginRatio(d[1507],m.price,!0),d.applyAction="<i class='fa fa-check fa-lg btn-apply text-success pointer' title='{0}'></i>".format(messages.eipo["btn-apply"].text),t.convertIPOData(d,l.schema.ipo,m),j.UpdateRowData(d),q[e]=d}j.draw(),c()}),u.subscribeApplications(function(a){for(var b=0;b<a.length;b++){var e=a[b],f=e[6];if(!f)return;e.DT_RowId="order-"+f,e.changeAction="<i class='fa fa-edit fa-lg btn-change text-success pointer' title='{0}' data-order='{1}'></i>".format(messages.eipo["btn-change"].text,e[6]),e.cancelAction="<i class='fa fa-remove fa-lg btn-cancel text-danger pointer' title='{0}' data-order='{1}'></i>".format(messages.eipo["btn-cancel"].text,e[6]),i(e),t.convertIPOData(e,l.schema.application,m),k.UpdateRowData(e),r[f]=e}k.draw(),c(),d()}),w.click(function(a){if($(a.target).hasClass("btn-apply")&&!$(a.target).attr("disabled")){var b=$(a.target).parent().parent().attr("id");if(b){var c=b.substring(7,b.indexOf("-",7)),d=b.substring(b.indexOf("-",7)+1);v&&l.disclaimer&&l.disclaimer.url?t.popupDisclaimer({url:l.disclaimer.url,multi_language:l.disclaimer.url,title:messages.eipo["ipo-disclaimer-title"].text,callback:function(a,b){var e=a.attr("id");"btn-agree"===e&&f(c,d),b.close()}}):f(c,d)}}}),x.click(function(a){$(a.target).attr("disabled")||($(a.target).hasClass("btn-cancel")?h($(a.target).attr("data-order")):$(a.target).hasClass("btn-change")&&g($(a.target).attr("data-order")))}),t.handleAcctUserUI(),e()})});