function initialize(a){$.get("/iTrader/initialize",function(b){initial_data=b,tags=b.tags,InitializeLanguage(),manualVerifySession(),$.get("/iTrader/account",function(b){b&&b.data&&(ExchangeMgr.set(b.data.tradeExchange),AccountMgr.setAcctInfo(b.data),CurrencyMgr.setInfo(b.data.currencyInfo),a(),b.data.forceReLogin&&(window.location.href="/iTrader/user/logout"))})})}function InitializeLanguage(){$("#nav_language").on("change",function(a,b){window.location.search="lang="+b});for(var a=[{key:lang,value:messages["lang_"+lang].text}],b=0;b<initial_data.languages.length;b++)_.find(a,function(a){return a.key===initial_data.languages[b]})||a.push({key:initial_data.languages[b],value:messages["lang_"+initial_data.languages[b]].text});DropdownGroupBind($("#nav_language-dropdown"),a)}function InitializeSite(){"undefined"!=typeof AccountMgr&&(AccountMgr.on(function(a){if(a&&a.account_list&&!(a.account_list.length<=0)){current.account=a.account_list[0],AccountMgr.current_account=a.account_list[0],$(".nav_current_account").each(function(){$(this).text(a.account_list[0])});for(var b=[],c=0;c<a.account_list.length;c++)b.push({key:a.account_list[c],value:a.account_list[c]});DropdownGroupBind($("#nav_accounts_dropdown"),b)}}),$("#nav_account").on("change",function(a,b){current.account=b,AccountMgr.current_account=b,$(".nav_current_account").each(function(){$(this).text(b)})}))}function popupWindow(a,b){if(b||(b={}),1==b.multi_language||"yes"===b.multi_language){var c=a.lastIndexOf(".");c>=0&&(a=a.substring(0,c)+"_"+lang+a.substring(c))}var d=b.height||750,e=b.width||600,f=b.top||0,g=b.left||0,h=b.menubar||"no",i=b.toolbar||"no",j=b.scrollbars||"yes",k=b.resizable||"yes",l=b.location||"no",m=b.status||"no",n=b.name||a,o="height="+d+",width="+e+",top="+f+",left="+g+",toolbar="+i+",menubar="+h+",scrollbars="+j+",resizable="+k+",location="+l+",status="+m,p=window.open(a,n,o);return openWindows.push(p),p}function PopupMarketDataWindow(a,b){var c="";b=b||{},"local"===a?(c="/iTrader/product/search",b.name="Symbol Search"):(c="/iTrader/product/market?name="+a,b.name=a+" Market Price"),b.width=b.width||800,b.height=b.height||700,b.left=window.screen.availWidth-10-b.width,b.status="yes",popupWindow(c,b)}function PopupeStatementWindow(a,b){b=b||{};var c="/itrader/estatement";b.name="estatement",b.width=b.width||800,b.height=b.height||700,b.left=window.screen.availWidth-10-b.width,b.status="yes",popupWindow(c,b)}function PopupAnnouncement(a){if(a)if("window"===a.type){var b={},c=a.url;b.multi_language=a.multi_language,b.width=800,b.height=400,b.top=(window.screen.availHeight-30-b.height)/2,b.left=(window.screen.availWidth-10-b.width)/2,popupWindow(c,b)}else{var c=a.multi_language?getMultiLanguageURL(a.url):a.url;alertMessage({title:messages.announcement_title.text,message:$("<div></div>").load(c)})}}function getMultiLanguageURL(a){var b="";if("string"==typeof a)b=a;else if("object"==typeof a){if(a.multi_language===!1)return a.url;b=a.url}if(b){var c=b.lastIndexOf(".");return c>=0&&(b=b.substring(0,c)+"_"+lang+b.substring(c)),b}}function validateForm(a,b){a.validate({submitHandler:b.submitHandler,highlight:b.highlight||function(a,b,c){$(a).closest(".form-group").addClass(b).removeClass(c).removeClass("control-label")},unhighlight:b.unhighlight||function(a,b,c){$(a).closest(".form-group").removeClass(b).addClass(c).removeClass("control-label")},errorPlacement:b.errorPlacement||function(a,b){},showErrors:b.showErrors,errorClass:"undefined"==typeof b.errorClass?"has-error control-label":b.errorClass,validClass:"undefined"==typeof b.validClass?"has-success":b.validClass,rules:b.rules||rules})}function handleError(a,b){a&&"object"==typeof a&&a.errorCode&&a.parameters&&a.parameters.length>=2&&"DCFUND009"!==a.errorCode&&(a.parameters[0]=$._format.pattern(a.parameters[0],initial_data.format.bond_unit),a.parameters[1]=$._format.pattern(a.parameters[1],initial_data.format.bond_unit));var c=getErrorMessage(a);alertError({message:c,onhide:b})}function getErrorMessage(a){var b;if(a)if("string"==typeof a)b=messages.error[a]||a;else if("object"==typeof a){var c=a.minorCode||a[tags.minorCode],d=a.errorCode||a[tags.errorCode],e=a.errorMsg||a.freeText||a[tags.freeText];b=errorMsgMapping(a)||messages.error[c]||messages.error[d]||e,b||a.status&&(401==a.status?navigate():403==a.status?(a.responseJSON&&a.responseJSON.errorCode&&(b=messages.error[a.responseJSON.errorCode]),b=b||a.statusText):b=503==a.status?messages.error.I_10002:a.statusText?a.statusText:messages.error.I_10004),b&&a.parameters&&a.parameters.length>0&&(b=b.cformat(a.parameters))}return b||messages.error.I_10004}function errorMsgMapping(a){function b(a,b){if(a&&b)return"d"===a?$._format.pattern(b,"#,##0.00######"):"n"===a?$._format.quantity(b):b}if(a&&a[tags.compSystemRef]&&a[tags.compSystemRef][tags.minorCode]){for(var c="",d=a[tags.compSystemRef][tags.minorCode].split(":"),e=0;e<d.length;e++){var f=d[e],g=messages.error[f];if(g){var h=a[tags.compSystemRef][f];if(!h)continue;for(var i=h.split(":"),j=[],k=0;k<i.length;k++)i[k].length>1&&j.push(b(i[k].substr(0,1),i[k].substring(1,i[k].length)));c+=g.cformat(j)+"<br />"}}return c}}function navigate(a){a=a||"/",location.href=a}function changeTheme(){$("[data-theme]").click(function(){var a=$(this).attr("data-theme");if(a){var b=new Date;b.setDate(b.getDate()+365),document.cookie="theme="+a+";expires="+b.toGMTString()+";path=/",window.location.reload()}})}function Logout(){for(var a=0;a<openWindows.length;a++)openWindows[a]&&openWindows[a].close();navigate("/iTrader/user/logout")}function NavDropdownBind(a,b){var c=a.find(".dropdown-text"),d=a.find(".dropdown-list");c.length<=0||d.length<=0||(c=$(c[0]),d=$(d[0]),_.isArray(b)&&b.length>0&&(c.text(b[0].value),d.empty()))}function DropdownGroupBind(a,b){if(a&&b&&!(b.length<=0)){var c=a.find(".dropdown-group-text"),d=a.find(".dropdown-group-list");if(!(c.length<=0||d.length<=0)&&(c=$(c[0]),d=$(d[0]),_.isArray(b)&&b.length>0)){d.empty(),c.text(b[0].value);for(var e=0;e<b.length;e++){var f=$("<a href='javascript:void(0)' data-key='"+b[e].key+"'>"+b[e].value+"</a>"),g=$("<li></li>").append(f);d.append(g),b[e].value===c.text()&&g.hide(),f.click(function(){d.find("li").show(),c.text($(this).text()),$(this).parent().hide(),c.trigger("change",$(this).attr("data-key"))})}}}}function PopupUserSetting(a,b){showMessage({title:messages.user_setting_title.text,load:{url:"/iTrader/account/setting/?tempNo="+(new Date).getTime(),callback:function(a){a.getModalBody().translate()}},buttonNameList:["submit","close"],callback:function(a,b){"close"===a.name?b.close():"submit"===a.name&&($.ajax({type:"post",url:"/iTrader/account/setting",data:$("#user-setting-form").serialize(),success:function(a){a&&(a.error?handleError(a.error):a.data&&layer.msg(messages.user_setting_msg.text))},error:handleError}),b.close())}})}function GetSymbolName(a){if(a){var b=$("html").attr("lang")||"en-US";return"zh-CN"===b?a[505]||a[21]||a.shortName:"zh-HK"===b?a[36]||a[21]||a.shortName:a[21]||a.shortName}return""}function GetShortSymbolName(a){if(a){var b=$("html").attr("lang")||"en-US";return"zh-CN"===b?a[505]||a.shortName||a[21]:"zh-HK"===b?a[36]||a.shortName||a[21]:a.shortName||a[21]}return""}function HandlerLoadPage(){$(document).on("page",function(a,b){"show"===b&&($(".loaders").remove(),$("body").removeClass("loader-container"),$($(".hide")[0]).removeClass("hide"),$(document).trigger("page","shown"))})}function getDisplayPrice(a,b,c){if(isNaN(a))return a;if(0===Number(a))return 0;var b=b||"market",d=c.displayRatio||c[1504]||1;a=d*a;var e=SpreadMgr.getSpreadPrecision(c,a),f="";if("market"==b)a=$._format.price(a,e);else if("order"==b){for(var g=0;g<8;g++)f+=g<e?"0":"#";a=$._format.price(a,"#,##0."+f)}else if("avg"===b){for(var g=0;g<8;g++)f+=g<=e?"0":"#";a=$._format.price(a,"#,##0."+f)}return a}function manualVerifySession(){if(initial_data&&initial_data.manualVerifyInterval&&!(initial_data.manualVerifyInterval<=0)){var a=!1;$(document).click(function(){a=!0}),$(document).keypress(function(){a=!0}),setInterval(function(){a&&$.post("/iTrader/user/verifySession",function(){a=!1})},1e3*initial_data.manualVerifyInterval)}}function maskEmailPhone(a){if(!a)return"";var b=a.indexOf("@");if(b>0){var c=a.substring(0,b);return c.length>6?a.replace(c,c.substr(0,3)+"****"+c.substr(-3)):c.length>2?a.replace(c,"****"+c.substr(-2)):a}var d="";return b=a.indexOf("-"),b>0&&(d=a.substr(0,b+1)),a.length>4?d+"*****"+a.substr(-4):a.length>2?d+"*****"+a.substr(-2):a}var lang,initial_data,tags,NotApplicableValue="N/A",openWindows=[],current={symbol:"",account:"",currency:""};$(function(){lang=$("html").attr("lang")||"en-US",InitializeSite(),$(window).unload(function(){for(var a=0;a<openWindows.length;a++)openWindows[a].close()}),changeTheme(),HandlerLoadPage(),"zh-HK"===lang?$.getScript("/javascripts/jquery-validation/localization/messages_zh_TW.js"):"zh-CN"===lang&&$.getScript("/javascripts/jquery-validation/localization/messages_zh.js")});