define(function(require,exports,module){function a(a,f){p=a,u.init($("#tab-bond-position"),f),m=$("#bond-buy-form"),n=$("#bond-sell-form"),s=$("#bond-buy-submit"),t=$("#bond-sell-submit"),d(),h(),i(),$(".bond-input-quantity").each(function(){$(this),$(this).InputFormat({format:function(a){return $._format.pattern(a,y)}})}),B.on("input",function(){$(this).val($(this).val().toUpperCase())}),B.blur(function(){r=!1;var a=$(this).val();b(a),$(this).parents("form").find(".bond-input-quantity").focus()}),B.keypress(function(a){13==a.keyCode&&$(this).trigger("blur")}),setTimeout(function(){e(function(a){c(a)})},1e3),s.click(function(a){var b=a.target.attributes["data-typeside"].nodeValue,c=$(".form-trade"),d=c.find(".symbol-code").val(),e=c.find(".bond-input-quantity").val();return d?e?void j(b):void c.find(".bond-input-quantity").focus():void c.find(".symbol-code").focus()}),t.click(function(a){var b=a.target.attributes["data-typeside"].nodeValue,c=$(".form-trade"),d=c.find(".symbol-code").val(),e=c.find(".bond-input-quantity").val();return d?e?void j(b):void c.find(".bond-input-quantity").focus():void c.find(".symbol-code").focus()}),$(document).translate()}function b(a){a&&f(a,function(a){if(!r){r=!0,IsOTCBond(a)||(a=null);var b=$(".bond-info");if(b.empty(),!a)return void b.append($("<h4>",{text:messages.ticket_message_invalid_symbol.text}));var c=$("<h4>",{text:a.symbolName}),d=$("<p>").append(c);a[3409]&&d.append($("<i>",{text:"Risk "+a[3409],"class":"highlight-tag",title:messages.tag_RPQ.title,style:"cursor: help;"})),"Y"==a[3602]&&d.append($("<i>",{text:"CIES ","class":"highlight-tag",title:messages.tag_CIES.title,style:"margin-left: 10px; cursor: help;"})),"1"==a[3603]&&d.append($("<i>",{text:"PI ","class":"highlight-tag",title:messages.tag_professional_investor.title,style:"margin-left: 10px; cursor: help;"})),b.append(d);for(var e=$(".active [href=#tab-bond-sell]").length>0?1:0,f=w.getBondInfo(a,{side:e}),h=$("<td>").append($("<small>",{text:f.price?f.price.name+f.price.value:""})),i=$("<td>").append($("<small>",{text:f.currency?f.currency.name+f.currency.value:""})),j=$("<td>").append($("<small>",{text:f.cRate?f.cRate.name+f.cRate.value:""})),k=$("<td>").append($("<small>",{text:f.cPFrequency?f.cPFrequency.name+f.cPFrequency.value:""})),l=$("<td>").append($("<small>",{text:f.miniInitSubAmount?f.miniInitSubAmount.name+f.miniInitSubAmount.value:""})),m=$("<td>").append($("<small>",{text:f.miniHoldingAmount?f.miniHoldingAmount.name+f.miniHoldingAmount.value:""})),n=$("<td>").append($("<small>",{text:f.minAmt?f.minAmt.name+f.minAmt.value:""})),o=$("<td>").append($("<small>",{text:f.incrementalAmt?f.incrementalAmt.name+f.incrementalAmt.value:""})),p=$("<td>").append($("<small>",{text:f.sDate?f.sDate.name+(f.sDate.value?moment(f.sDate.value,"YYYYMMDD").format("YYYY/MM/DD"):""):""})),q=$("<td>").append($("<small>",{text:f.preCouDate?f.preCouDate.name+(f.preCouDate.value?moment(f.preCouDate.value,"YYYYMMDD").format("YYYY/MM/DD"):""):""})),s=$("<td>").append($("<small>",{text:f.txn?f.txn.name+$._format.percentage(f.txn.value,2):""})),t=$("<td>").append($("<small>",{text:f.minTxnAmount?f.minTxnAmount.name+f.minTxnAmount.value:""})),u=$("<td>").append($("<small>",{text:f.txnSell?f.txnSell.name+$._format.percentage(f.txnSell.value,2):""})),v=$("<td>").append($("<small>",{text:f.minTxnAmountSell?f.minTxnAmountSell.name+f.minTxnAmountSell.value:""})),x=$("<td>").append($("<small>",{text:f.availableQuantity?f.availableQuantity.name+f.availableQuantity.value:""})),y=g([h,i,j,k,n,o,p,q,s,t,u,v,x,l,m]),z=$("<table>",{"class":"table table-condensed"}),A=0;A<y.length;A++)z.append(y[A]);b.append(z)}})}function c(a,b){if(a){b=b||{},o.clear();for(var c=0;c<a.length;c++)if(a&&a[0]){var d=a[c],e=d[0].toLowerCase(),f=GetMaxSellSync(d[0]),g=d.symbolName.toLowerCase();b.query&&e.indexOf(b.query)<0&&g.indexOf(b.query)<0||b.hasPosition&&Number(f)<=0||("undefined"==typeof d.oriCouponRate&&(d.oriCouponRate=d.couponRate),d.oriCouponRate&&(d.couponRate=$._format.pattern(100*d.oriCouponRate,"#,##0.########")+"%"),o.UpdateRowData(a[c]))}o.draw(),$(document).translate(),$("#daily-quote-table tbody").find(".copyprice").click(function(a){var b=a.target.innerText;$("#ticket-input-symbol-code").val(b).trigger("blur")})}}function d(){var a=$("#daily-quote-table");o=a.CreateDatatable({columnSchema:C,searching:!0,order:[0,"asc"],buttons:[{extend:"print",exportOptions:{columns:function(a,b,c){return a>1}},className:"btn-print"}],columnDefs:[{className:"copyprice",targets:[0]}]}),a.on("click","td",function(a){if($(this).hasClass("copyprice")){var b=a.currentTarget.innerText;$("#ticket-input-symbol-code").val(b).trigger("blur")}});var b=$(o.table().container()),c=o.buttons().container();c.addClass("pull-right"),c.find("a span").remove(),c.find("a").append($("<i class='fa fa-lg fa-print text-muted'></i>")),c.appendTo(b.find(".dataTables_filter label"))}function e(a){return q?a(q):void $.get("/iTrader/Bond?dailyBondList=1",function(b){q=b,a(b)})}function c(a,b){if(a){b=b||{},o.clear();for(var c=0;c<a.length;c++){var d=a[c];d&&d[0]&&(d.DT_RowId="bond-"+d[0],d[30]&&(d.symbolName+=" ("+d[30]+")"),d[20]&&ExchangeMgr.exchange_flag[d[20]]&&(d[0]="<i class='flag-icon {0}' style='margin-right:5px;'></i>{1}".format(ExchangeMgr.exchange_flag[d[20]],d[0])),d.offeringDocLink&&(d.offeringDocLink="<a href='{0}' target='_blank'><i class='fa fa-link'></i>{1}</a>".format(d.offeringDocLink,messages.column_offering_document_link.text)),"undefined"==typeof d.oriCouponRate&&(d.oriCouponRate=d.couponRate),d.oriCouponRate&&(d.couponRate=$._format.pattern(100*d.oriCouponRate,"#,##0.########")+"%"),o.UpdateRowData(a[c]))}o.draw(),$(document).translate()}}function f(a,b){a?z[a]?b(z[a]):$.get("/iTrader/product?symbol="+a,function(c){var d=c.data;d?(z[a]=d,b(d)):b()}):b()}function g(a){if(a){for(var b=[$("<tr>")],c=0;c<a.length;c++){var d=$(b[b.length-1]);if(d.find("td").length<3)a[c].text()&&d.append(a[c]);else{var e=$("<tr>");a[c].text()&&e.append(a[c]),b.push(e)}}if(e&&a.length%3!==0)for(var c=0;c<3-a.length%3;c++)e.append("<td></td>");return b}}function h(){validateForm(m,{submitHandler:function(a){var b=$(a).find(".symbol-code").val();b&&z[b]&&k(function(b){b&&v.submitCalcorder($(a).serialize()+"&account="+AccountMgr.current_account,{confirmBoxTitle:messages.order_confirmation_bond_title.text})})}})}function i(){validateForm(n,{submitHandler:function(a){var b=$(a).find(".symbol-code").val();b&&z[b]&&k(function(b){b&&v.addNewPendSymbol($(a).serialize()+"&account="+AccountMgr.current_account)})}})}function j(a){var b=$(".form-trade"),c=a,d="",e="",f=b.find(".symbol-code").val(),g=b.find(".bond-input-quantity").val();d="symbol="+f+"&quantity="+g+"&_csrf="+A+"&side="+c;var h=10;$("#bond-disclosure-panel").length>0&&(e=x.getDiscolsureCheckBox(h)),k(function(a){a?v.submitCalcorder(d,{confirmBoxTitle:messages.order_confirmation_bond_title.text}):l()})}function k(a){$.get("/iTrader/bond/disclaimer",function(b){b&&b.url?showMessage({title:messages.dialog_disclosure_title.text,buttonNameList:["agree","reject"],load:{url:getMultiLanguageURL(b)},callback:function(b,c){var d=b.attr("id");"btn-reject"===d?(a(!1),a=null):"btn-agree"===d&&(a(!0),a=null),c.close()},onshow:function(a){a.getModalBody().css("max-height","450px")},onhide:function(){a&&a(!1)}}):a(!0)})}function l(){initial_data.ticket.clearAfterSubmit&&resetForm()}require("datatables");var m,n,o,p,q,r,s,t,u=require("bond-position"),v=require("ticket"),w=require("bond-ticket"),x=require("full-trade"),y=initial_data.format.bond_unit,z={},A=$("input[name=_csrf]").val(),B=$(".symbol-code"),C=[{name:"symbol",key:"0",i18n:"bond_symbol_code"},{name:"symbol name",key:"symbolName",i18n:"bond_name"},{name:"currency",key:"23",i18n:"column_currency"},{name:"preClose",key:"31",i18n:"column_pre_close","class":"text-right"},{name:"couponRate",key:"couponRate",i18n:"column_coupon_rate"},{name:"risk",key:"RPQLevel",i18n:"column_risk_level","class":"text-right"},{name:"cies",key:"CIESFlag",i18n:"column_CIES"},{name:"professional investor",key:"PIFlag",i18n:"column_professional_investor"}];$(document).on("page",function(a,b){"shown"===b&&o&&o.draw()}),exports.init=a});