function OrderBook_Initialize(){if(orderbook_panel=$("#order-book-panel"),!(orderbook_panel.length<=0||(orderbook_table=$("#orderbook-table"),orderbook_table.length<=0))){initial_data.views.trade.order_book.schema;orderbook_datatable=orderbook_table.CreateDatatable({columnSchema:initial_data.views.trade.order_book.schema,columnHeaderPrefix:"orderbook_header_",order:[3,"desc"],aoColumnDefs:[{bSortable:!1,aTargets:[0,1]},{className:"pointer",targets:[3]}],buttons:[{extend:"print",exportOptions:{columns:function(a,b,c){return a>1}},className:"btn-print"}]});var a=$(orderbook_datatable.table().container()),b=orderbook_datatable.buttons().container();b.addClass("pull-right"),b.find("a span").remove(),b.find("a").append($("<i class='fa fa-lg fa-print text-muted'></i>")),b.appendTo(a.find(".dataTables_filter label")),$("#orderbook-filter").appendTo($(".col-sm-6:eq(0)",a)),$(document).on("orders",function(a,b){b&&b.orders&&(_(b.orders).forEach(function(a){"cash"===a.voucherType||IsOTCFund(a)||OrderBookTable_Add(a)}),orderbook_datatable.draw(!1))});for(var c=$("#orderbook-status-dropdown-group"),d={name:{i18n:"history_order_filter_status"},data:[{key:"ALL",value:messages.ALL.text}]},e=initial_data.views.trade.order_book.filter.status,f=0;f<e.length;f++)d.data.push({key:e[f],value:$._map.status(e[f])});c.CreateDrowdownGroup(d);var g=orderbook_datatable.columns().dataSrc();if(g.length>0){var h=g.indexOf("status_text");if(h<=0)return;c.on("change",function(a,b){b="ALL"===b?"":$._map.status(b),orderbook_datatable.column(h).search(b).draw()})}orderbook_table.on("click",function(a){var b=$(a.target),c=b.attr("action"),d=b.parents("tr").attr("id");d&&d.length>6&&("change"===c?seajs.use("ticket",function(a){a.changeOrder(d.substring(6))}):"cancel"===c&&seajs.use("ticket",function(a){a.cancelOrder(d.substring(6))}))})}}function OrderBookTable_Add(a){if(orderbook_table&&!(orderbook_table.length<=0)&&"object"==typeof a&&a[tags.orderNo]){var b=a[tags.orderNo];a.DT_RowId="order-"+b,OrderBook_IsBulkChildOrder(a);var c=OrderBook_IsChangeable(a),d=OrderBook_IsCancelable(a);c?a.change="<a href='javascript:void(0);'><i class='fa fa-edit fa-lg text-success' title='{0}' action='change'></i></a>".format(messages.orderbook_change.text):a.change="<i class='fa fa-edit fa-lg text-muted' title='{0}'></i>".format(messages.orderbook_change.text),d?a.cancel="<a href='javascript:void(0);'><i class='fa fa-remove fa-lg text-danger' title='{0}' action='cancel'></i></a>".format(messages.orderbook_cancel.text):a.cancel="<i class='fa fa-remove fa-lg text-muted' title='{0}'></i>".format(messages.orderbook_cancel.text);var e=orderbook_datatable.UpdateRowData(a);OrderBookColorSchema_Apply(e),initial_data.views.trade.order_book.trade_detail&&e&&e.isNewRow&&OrderBookDetail_Apply(e)}}function OrderBookColorSchema_Apply(a){if(a&&a.data()){var b=initial_data.views.trade.order_book.color_schema;if(b&&!(b.length<=0))for(var c=a.data()[tags.status],d=a.data()[tags.side],e=0;e<b.length;e++){var f=b[e].status,g=b[e].side;"undefined"!=typeof f&&c!=f||"undefined"!=typeof g&&d!=g||(b[e]["class"]&&$(a.node()).addClass(b[e]["class"]),b[e].color&&$(a.node()).css("color",b[e].color),b[e].background&&$(a.node()).css("background-color",b[e].background))}}}function OrderBookDetail_Apply(a){a&&a.data()&&$(a.node()).find(".pointer").click(function(){var b=a.data()[tags.orderNo];if(b){var c=OrderMgr.get(b);c&&showMessage({title:messages.order_detail_title.text+c[tags.account],type:"0"==c[tags.side]?BootstrapDialog.TYPE_SUCCESS:BootstrapDialog.TYPE_DANGER,load:{url:"/iTrader/order/get?orderNo="+b+"&tempNo="+(new Date).getTime(),callback:function(a){OrderBookTradeDetail_Add(c),a.$modal.format(),a.$modal.translate(),$("#order-detail-datetime").text(c.datetime),$("#order-detail-price").text(c[tags.price]),$("#order-detail-avgPrice").text(c[tags.price2]),$("#order-detail-side").text(c.side_text),$("#order-detail-status").text(c.status_text)}}})}})}function OrderBookTradeDetail_Add(a){if(a&&a.trades&&!$.isEmptyObject(a.trades)){var b=$("#order-detail-table"),c=b.CreateDatatable({columnSchema:initial_data.views.trade.order_book.trade_schema,columnHeaderPrefix:"trade_detail_header_",paging:!1,ordering:!1,info:!1,searching:!1,autoWidth:!0});for(var d in a.trades){var e=a.trades[d];e.DT_RowId="trade-"+e[tags.tranNo],c.UpdateRowData(e)}c.draw(),b.format(),b.removeClass("hidden")}}function OrderBook_IsChangeable(a){if(a){if(a.isBulkChildOrder)return!1;var b=initial_data.views.trade.order_book.change;if(b){var c=a[tags.status],d=a[tags.operatorFlag];return b.status.indexOf(c)>=0&&(b.channel.indexOf(d)>=0||b.channel.indexOf("*")>=0)?b.changeable:!b.changeable}}}function OrderBook_IsCancelable(a){if(a){if(a.isBulkChildOrder)return!1;var b=initial_data.views.trade.order_book.cancel;if(b){var c=a[tags.status],d=a[tags.operatorFlag];return b.status.indexOf(c)>=0&&(b.channel.indexOf(d)>=0||b.channel.indexOf("*")>=0)?b.cancelable:!b.cancelable}}}function OrderBook_IsBulkChildOrder(a){if(a&&a[489]&&32768&a[489]){a.isBulkChildOrder=!0;var b=a[25]||"";b.indexOf(messages.remark_bulk_order.text)<0&&(b=messages.remark_bulk_order.text+b),a[25]=b}}var orderbook_panel,orderbook_table,orderbook_datatable;