function OrderTicket_Initialize(){ticket_panel=$("#ticket-panel"),ticket_panel.length<=0||(ticket_form=$("#ticket-form"),ticket_select_exchange=$("#ticket-select-exchange"),ticket_input_Price=$("#ticket-input-price"),ticket_input_Quantity=$("#ticket-input-quantity"),ticket_input_SymbolCode=$("#ticket-input-symbol-code"),ticket_input_SymbolName=$("#ticket-input-sysbol-name"),ticket_select_OrderType=$("#ticket-order-type"),ticket_select_tif=$("#ticket-order-tif"),ticket_gtd_addon=$("#ticket-gtd-addon"),ticket_btn_buy_side=$("#ticket-btn-buy-side"),ticket_btn_sell_side=$("#ticket-btn-sell-side"),ticket_select_OrderType.popover({html:!0,trigger:"manual",title:messages.ticket_stop_price_title.text}),ticket_input_SymbolCode.blur(function(){TicketSymbol_Update()}),ticket_select_exchange.change(function(){Ticker_OrderType_Filter(),ticket_select_OrderType.trigger("change"),ticket_select_tif.trigger("change"),TicketSymbol_Update()}),ticket_input_SymbolCode.change(function(){ticket_valid_symbol_code="",ticket_input_Quantity.val(""),TicketPrice_Set()}),ticket_input_Price.blur(function(){TicketMaxBuySell_Calculate()}),ticket_select_OrderType.change(function(){"market"===ticket_select_OrderType.val()||"auction"===ticket_select_OrderType.val()?(ticket_input_Price.attr("disabled","disabled"),TicketPrice_Set(),ticket_select_tif.val("day"),ticket_select_tif.attr("disabled","disabled"),ticket_select_tif.trigger("change")):(ticket_input_Price.removeAttr("disabled"),ticket_select_tif.removeAttr("disabled"),TicketPrice_Set(ticket_input_Price.val())),"stopLimit"===ticket_select_OrderType.val()?($("#ticket-stop-price-hint").removeClass("hidden"),ticket_select_OrderType.on("popover-show",function(){ticket_select_OrderType.popover("show"),TicketSpinner_Set(),$("#ticket-input-stop-price").val($("#ticket-stop-price").text()||""),$("#ticket-input-stop-price").blur(function(){$(document).one("click",function(){$("#ticket-stop-price").text($("#ticket-input-stop-price").val()||"0.00"),ticket_select_OrderType.popover("toggle")})}).keypress(function(a){13==a.which&&a.preventDefault()}),$(".popover-content").click(function(a){a.stopPropagation()})}),ticket_select_OrderType.trigger("popover-show"),$("#ticket-stop-price").click(function(){ticket_select_OrderType.trigger("popover-show"),$("#ticket-input-stop-price").focus()})):($("#ticket-stop-price-hint").addClass("hidden"),ticket_select_OrderType.popover("hide"))}),ticket_select_tif.change(function(){ticket_select_tif.val().indexOf("gtd")>=0?ticket_gtd_addon.removeClass("hidden"):ticket_gtd_addon.addClass("hidden")}),TicketSpinner_Set(),TicketGTD_Pick(),TicketOrder_Calculate(),Ticket_ApplyShortcut(),ticket_panel.on("add",function(a,b){TicketSymbol_Input(b)}),$(document).on("account",function(){setTimeout(function(){TicketMaxBuySell_Calculate()},500)}),$(document).on("position-quantity-update",function(){TicketMaxBuySell_Calculate()}),$(document).on("exchange",function(){TicketExchange_Select(),Ticker_OrderType_Filter(),ticket_select_OrderType.trigger("change"),ticket_select_tif.trigger("change")}))}function TicketPrice_Set(a){return a=a||"",a=ticket_input_Price.attr("disabled")?"0":"0"===a?"":a,ticket_input_Price.val(a),ticket_input_Price}function TicketSymbol_Update(){current.symbol=ticket_input_SymbolCode.val(),ticket_input_SymbolCode.val(ExchangeRule_Apply(ticket_input_SymbolCode.val())),ticket_valid_symbol_code="",ticket_input_SymbolName.html(""),$("#ticket-lot-size").parent().addClass("hidden"),$("#ticket-max-buy-sell-hint").addClass("hidden"),$("#ticket-currency-hint").text("");var a=ticket_input_SymbolCode.val();a&&(ticket_input_SymbolName.addClass("text-danger"),ticket_input_SymbolName.text(messages.ticket_message_invalid_symbol.text).attr("title",""),GetProduct(a,{flag:0},function(b){if(b){if(b[tags.symbol]!==ticket_input_SymbolCode.val())return;if(b[tags.exchange]!==ticket_select_exchange.val())return;ticket_valid_symbol_code=a,ticket_input_SymbolName.removeClass("text-danger");var c=b.symbolName||b[tags.account]||"";ticket_input_SymbolName.text(c),ticket_input_SymbolName.attr("title",c),$("#ticket-currency-hint").text(b[tags.currency]||""),current.symbol=a,$("#ticket-lot-size").text($._format.quantity(b[tags.lotSize])).parent().removeClass("hidden"),$("#ticket-max-buy-sell-hint").removeClass("hidden"),TicketMaxBuySell_Calculate(),$(document).trigger("ticket-added",b)}}))}function TicketSymbol_Input(a){"object"==typeof a&&(a.exchange&&(ticket_select_exchange.val(a.exchange),$(".custom-options").selectric("refresh")),ticket_input_SymbolCode.val(a.symbol).focus(),setTimeout(function(){TicketPrice_Set(a.price).focus(),"undefined"!=typeof a.quantity&&ticket_input_Quantity.val(a.quantity).focus()},50))}function TicketExchange_Select(){$(".custom-options").selectric({optionsItemBuilder:function(a,b,c){return'<i class="icon-margin flag-icon '+(ExchangeMgr.exchange_flag[a.value]||"")+'"></i>'+$._map.exchange(a.value)},labelBuilder:function(a){return'<i class="icon-margin flag-icon '+(ExchangeMgr.exchange_flag[a.value]||"")+'"></i>'+$._map.exchange(a.value)}})}function TicketGTD_Pick(){$("#ticket-gtd-picker").datepicker({startDate:"today",todayHighlight:!0,autoclose:!0}).on("changeDate",function(){var a=$(this).datepicker("getDate");$("#ticket-gtd-option").text(messages.oms.order_tif_gtd_pre+" ["+moment(a).format("MM/DD/YY")+"]"),$("#ticket-gtd-option").val("gtd:"+moment(a).format("YYYY/MM/DD"))})}function TicketSpinner_Set(){$(".price-spinner:not(.spinner-done)").spinner({min:0,precision:10,step:function(a){var b,c=Number(ProductMgr.getSpreadValue(current.symbol,this.oldValue));return"up"===a?(b=Math.ceil(this.oldValue/c)*c,Math.abs(b-this.oldValue)<1e-4?c:b-this.oldValue):(b=Math.floor(this.oldValue/c)*c,Math.abs(b-this.oldValue)<1e-4?c:this.oldValue-b)}}).spinner("changing",function(a,b,c){var d=ProductMgr.getSpreadPrecision(current.symbol,b);$(this).val($.number(b,d,".",""))}),$(".quantity-spinner:not(.spinner-done)").spinner({min:0,step:function(a){var b,c=ProductMgr.getLotSize(current.symbol);return"up"===a?(b=Math.ceil(this.oldValue/c)*c,Math.abs(b-this.oldValue)<1e-4?c:b-this.oldValue):(b=Math.floor(this.oldValue/c)*c,Math.abs(b-this.oldValue)<1e-4?c:this.oldValue-b)}}),$(".price-spinner:not(.spinner-done),.quantity-spinner:not(.spinner-done)").find("input").each(function(){Number($(this).val())||$($(this).val(""))}),$(".price-spinner:not(spinner-done) input").blur(function(){var a=Number($(this).val());if(!isNaN(a)){var b=0==a?0:ProductMgr.getSpreadPrecision(current.symbol,a);$(this).val($.number(a,b,".",""))}}),$(".price-spinner,.quantity-spinner").addClass("spinner-done")}function ExchangeRule_Apply(a){var b=ticket_select_exchange.val();if(initial_data.exchange_rule&&initial_data.exchange_rule[b]){var c=initial_data.exchange_rule[b];c.rule&&exchangeRules[c.rule]&&(a=exchangeRules[c.rule](a,c.options))}return a}function TicketForm_Reset(){document.getElementById("ticket-form").reset(),$("#ticket-stop-price-hint").addClass("hidden"),$("#ticket-stop-price").text("0.00"),$("#ticket-gtd-option").text(messages.oms.order_tif_gtd),$("#ticket-gtd-option").val("gtd"),ticket_select_OrderType.trigger("change"),ticket_select_tif.trigger("change"),TicketSymbol_Update()}function TicketMaxBuySell_Calculate(){$("#ticket-max-buy").text($._format.quantity(GetMaxBuy(ticket_valid_symbol_code,ticket_input_Price.val()))),$("#ticket-max-sell").text($._format.quantity(GetMaxSell(ticket_valid_symbol_code)))}function TicketOrder_Calculate(){ticket_btn_buy_side.click(function(){ticket_order_side=0}),ticket_btn_sell_side.click(function(){ticket_order_side=1}),validateForm(ticket_form,{submitHandler:function(a){if(ticket_valid_symbol_code&&(!initial_data.ticket||initial_data.ticket.allowZeroPrice!==!1||ticket_input_Price.attr("disabled")||0!=Number(ticket_input_Price.val()))){var b=Number($("#ticket-stop-price").text());"stopLimit"===ticket_select_OrderType.val()&&b<=0||("gtd"!==ticket_select_tif.val()||ticket_gtd_date)&&(ticket_form_data=$(a).serialize()+"&side="+ticket_order_side+"&account="+current.account+"&stopPrice="+b,0===ticket_order_side?ticket_btn_buy_side.addClass("disabled"):1===ticket_order_side&&ticket_btn_sell_side.addClass("disabled"),$.ajax({type:"post",url:"/iTrader/order/calculate",data:ticket_form_data,success:function(a){a.error?handleError(a.error):TicketOrder_Add(a.data),ticket_btn_buy_side.removeClass("disabled"),ticket_btn_sell_side.removeClass("disabled")},error:function(a){handleError(a),ticket_btn_buy_side.removeClass("disabled"),ticket_btn_sell_side.removeClass("disabled")}}))}},errorClass:"error",validClass:"success"})}function TicketOrder_Add(a){a&&a[tags.userRef]&&!isNaN(a[tags.side])&&showMessage({title:messages.ticket_order_add_confirmation_title.text+AccountMgr.current_account,type:"0"==a[tags.side]?BootstrapDialog.TYPE_SUCCESS:BootstrapDialog.TYPE_DANGER,load:{url:"/iTrader/order/add?ref="+a[tags.userRef],callback:function(a){a.$modal.format(),a.$modal.translate(),a.$modal.find("[data-format=price]").each(function(){$(this).text($._format.price($(this).text(),ProductMgr.getSpreadPrecision(current.symbol,$(this).text())))})}},buttonNameList:["submit","close"],callback:function(a,b){if("close"===a.name)b.close();else if("submit"===a.name){var c=$("#add-order-form");validateForm(c,{submitHandler:function(){var a=c.find("[name=password]"),d=ticket_form_data+"&cmd=add";a.length>0&&(d+="&password="+a.val()),b.close(),TicketOrder_Submit(d,function(a){a.error?handleError(a.error,function(){a.error.showCBBCAgreement&&showMessage({title:messages.dialog_cbbc_agreement_title.text,buttonNameList:["agree","reject"],load:{url:"/html/CBBCArgeement_"+lang+".html"},callback:function(a,b){var c=a.attr("id");"btn-reject"===c?b.close():"btn-agree"===c&&(b.close(),TicketOrder_SaveCBBCAgreement())},onshow:function(a){a.getModalBody().css("max-height","450px")}})}):alertMessage({title:messages.dialog_information_title.text,message:messages.order_confirmation_order_submitted_message.text})})}}),c.valid()&&c.submit()}}})}function TicketOrder_Change(a){var b=OrderMgr.get(a);b&&showMessage({title:messages.ticket_order_change_confirmation_title.text+b[tags.account],type:"0"==b[tags.side]?BootstrapDialog.TYPE_SUCCESS:BootstrapDialog.TYPE_DANGER,load:{url:"/iTrader/order/change?orderNo="+a+"&tempNo="+(new Date).getTime(),callback:function(a){current.symbol=$("#change-confirmation-symbol").text(),$("#order-change-gtd").datepicker({startDate:"today",todayHighlight:!0,autoclose:!0,format:"yyyy/mm/dd"}),a.$modal.format(),a.$modal.translate(),TicketSpinner_Set(),a.$modal.find("[data-format=price]").each(function(){var a=$(this).val()||$(this).text(),b=ProductMgr.getSpreadPrecision(current.symbol,a),c=$._format.price(a,b);$(this).val(c),$(this).text(c)})}},buttonNameList:["submit","close"],callback:function(a,b){if("close"===a.name)b.close();else if("submit"===a.name){var c=$("#change-order-form");validateForm(c,{submitHandler:function(){var a=c.find("[data-format=price]");if(!(a.length>1&&initial_data.ticket&&initial_data.ticket.allowZeroPrice===!1&&0==Number($(a[1]).val()))){var d=c.serialize()+"&cmd=change";b.close(),TicketOrder_Submit(d,function(a){a.error?handleError(a.error):alertMessage({title:messages.dialog_information_title.text,message:messages.order_confirmation_order_change_submitted_message.text})})}}}),c.valid()&&c.submit()}},onhide:function(a){current.symbol=ticket_input_SymbolCode.val()}})}function TicketOrder_Cancel(a){var b=OrderMgr.get(a);b&&showMessage({title:messages.ticket_order_cancel_confirmation_title.text+b[tags.account],type:"0"==b[tags.side]?BootstrapDialog.TYPE_SUCCESS:BootstrapDialog.TYPE_DANGER,load:{url:"/iTrader/order/cancel?orderNo="+a+"&tempNo="+(new Date).getTime(),callback:function(a){current.symbol=$("#cancel-confirmation-symbol").text(),a.$modal.format(),a.$modal.translate(),a.$modal.find("[data-format=price]").each(function(){$(this).text($._format.price($(this).text(),ProductMgr.getSpreadPrecision(current.symbol,$(this).text())))})}},buttonNameList:["submit","close"],callback:function(a,b){if("close"===a.name)b.close();else if("submit"===a.name){var c=$("#cancel-order-form");validateForm(c,{submitHandler:function(){var a=c.serialize()+"&cmd=cancel";b.close(),TicketOrder_Submit(a,function(a){a.error?handleError(a.error):alertMessage({title:messages.dialog_information_title.text,message:messages.order_confirmation_order_cancel_submitted_message.text})})}}),c.valid()&&c.submit()}},onhide:function(){current.symbol=ticket_input_SymbolCode.val()}})}function TicketOrder_Submit(a,b){$.ajax({type:"post",url:"/iTrader/order/submit",data:a,success:b,error:handleError})}function TicketOrder_SaveCBBCAgreement(){$.ajax({type:"post",url:"/iTrader/message/agreement",data:{name:"SaveCBBCAgreementFlag",value:1,_csrf:$("[name=_csrf]").attr("value")},success:function(a){a.error&&layer.msg(getErrorMessage(a.error))},error:function(a){layer.msg(getErrorMessage(a))}})}function Ticket_ApplyShortcut(){function a(a,b){if(a){var c=Number(a);isNaN(c)?shortcut.add(a,b):shortcut.add("",b,{keycode:c})}}var b=initial_data.views.trade.ticket.shortcut;b&&b.enable&&(a(b.buy,function(){ticket_order_side=0,ticket_form.submit()}),a(b.sell,function(){ticket_order_side=1,ticket_form.submit()}),a(b.reset,function(){TicketForm_Reset()}),a(b.refresh,function(){refresh&&refresh(["account","product"])}),a(b.tabUp,function(){var a=$(":focus");if(a&&a.length>0){var b=Number(a.attr("tabindex"));b>1&&b<=8&&$("[tabindex="+(b-1)+"]").focus()}}),a(b.tabDown,function(){var a=$(":focus");if(a&&a.length>0){var b=Number(a.attr("tabindex"));b>=1&&b<8&&$("[tabindex="+(b+1)+"]").focus()}}))}function Ticker_OrderType_Filter(){function a(a,b){if(a&&b)for(var c=0;c<a.length;c++)if(0===$(a[c]).val().indexOf(b))return a[c]}ticket_order_type_options||(ticket_order_type_options=ticket_select_OrderType.find("option")),ticket_tif_options||(ticket_tif_options=ticket_select_tif.find("option"));var b=ticket_select_exchange.val();if(b){ticket_select_OrderType.find("option").remove();for(var c=0;c<ExchangeMgr.exchange_orderType[b].length;c++){var d=ExchangeMgr.exchange_orderType[b][c];ticket_select_OrderType.append(a(ticket_order_type_options,d)||"")}ticket_select_OrderType.get(0).selectedIndex=0,ticket_select_tif.find("option").remove();for(var c=0;c<ExchangeMgr.exchange_tif[b].length;c++){var e=ExchangeMgr.exchange_tif[b][c];ticket_select_tif.append(a(ticket_tif_options,e)||"")}ticket_select_tif.get(0).selectedIndex=0}}var ticket_panel,ticket_form,ticket_form_data,ticket_select_exchange,ticket_input_Price,ticket_input_Quantity,ticket_input_SymbolCode,ticket_input_SymbolName,ticket_select_OrderType,ticket_select_tif,ticket_gtd_addon,ticket_btn_buy_side,ticket_btn_sell_side,ticket_order_side,ticket_valid_symbol_code,ticket_gtd_date,ticket_order_type_options,ticket_tif_options;