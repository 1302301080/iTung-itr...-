function Portfolio_Initialize(){if(portfolio_panel=$("#portfolio-panel"),!(portfolio_panel.length<=0)){portfolio_exchange_dropdown=$("#portfolio-dropdown-group"),portfolio_table=$("#portfolio-table");for(var a=initial_data.views.trade.portfolio.schema,b=[],c=0;c<a.length;c++)b.push(a[c]);b.push({key:"hide_exchange"}),b.push({key:"hide_account"}),portfolio_datatable=portfolio_table.CreateDatatable({columnSchema:b,columnHeaderPrefix:"portfolio_header_",pageLength:7,columnDefs:[{className:"copyprice portfolio-extra",targets:[0]}]});var d=portfolio_datatable.columns()[0].length;portfolio_datatable.column(d-1).visible(!1),portfolio_datatable.column(d-2).visible(!1);var e=$(portfolio_datatable.table().container()),f=portfolio_datatable.buttons().container();e.find(".dataTables_filter label").addClass("search-box").appendTo($("#portfolio-search")),f.addClass("pull-right"),f.find("a span").remove(),f.find("a").append($("<i class='fa fa-lg fa-print text-muted'></i>")),f.appendTo(e.find(".dataTables_filter label")),$("#nav_account").on("change",function(a,b){portfolio_datatable.clear();for(var c=PositionMgr.get({account:b}),d=0;d<c.length;d++)PortfolioTable_Add(c[d]);PortfolioTable_Filter()}),$(document).on("exchange",function(a,b){PortfolioExchangeDropdownGroup_Reset()}),portfolio_exchange_dropdown.on("change",function(a,b){portfolio_current_exchange="ALL"===b?"":b,PortfolioTable_Filter()}),PositionMgr.on(function(a){if(a&&!(a.length<=0)){for(var b=0;b<a.length;b++)console.log(a[b]),PortfolioTable_Add(a[b]);PortfolioTable_Filter()}}),$(document).on("position-quantity-update",function(a,b){b&&(PortfolioTable_Add(b),PortfolioTable_Filter())}),$(document).on("products",function(a,b){if(b&&b.products){for(var c=!1,d=0;d<b.products.length;d++){var e=b.products[d],f=PositionMgr.get({symbol:e[tags.symbol],account:AccountMgr.current_account});if(f&&!(f.length<=0)){c=!0;for(var g=0;g<f.length;g++)PositionMgr.calc(f[g],e),PortfolioTable_Add(f[g])}}c&&PortfolioTable_Filter()}}),$(document).on("margin",function(a,b){if(b){var c=b[tags.symbol],d=b[tags.account];if(c&&d){var e=ProductMgr.get(c);if(e){var f=PositionMgr.get({symbol:c,account:d});if(f&&f.length>0){for(var g=0;g<f.length;g++)PositionMgr.calc(f[g],e),PortfolioTable_Add(f[g]);PortfolioTable_Filter()}}}}})}}function PortfolioTable_Add(a){if(a){var b=a[4];if(b===AccountMgr.current_account){var c=Portfolio_GetPositionObj(a);if(!($("#portfolio-panel").length<=0)&&c){var d=a[tags.symbol],e=a[tags.exchange];c.DT_RowId="position-"+b+"-"+d,c.hide_exchange="#"+(e||"")+"#",c.hide_account="#"+(b||"")+"#";var f=a[1504]||1,g=a.costPrice*f;c.costPrice=$._format.price(g,ProductMgr.getSpreadPrecision(d,g)+1);var h=portfolio_datatable.UpdateRowData(c,{IsRemove:function(a){return 0==a[tags.quantity]}});h&&h.isNewRow&&($(h.node()).find(".copyprice").click(function(){var a=PositionMgr.get({symbol:$(this).text(),account:AccountMgr.current_account});if(a&&a.length>0){var b={name:"copy-symbol",exchange:a[0][tags.exchange],symbol:a[0][tags.symbol],quantity:GetMaxSell($(this).text())};window.postMessage(b,"/")}}),$(h.node()).find(".portfolio-extra").each(function(){if("tooltip"!==$(this).attr("data-toggle")){$(this).attr("data-toggle","tooltip").attr("data-placement","right");var a=this;$(this).tooltip({html:!0,container:"body",trigger:"hover",title:function(){var b=portfolio_datatable.row("#"+$(a).parent("tr").attr("id"));if(b&&b.data())return PortfolioTable_Hint(b.data())}})}}))}}}}function PortfolioExchangeDropdownGroup_Reset(){for(var a={name:{i18n:"portfolio_market"},data:[{key:"ALL",value:messages.ALL.text}]},b=0;b<ExchangeMgr.exchanges.length;b++){var c=ExchangeMgr.exchanges[b];a.data.push({key:c,value:$._map.exchange(c)})}portfolio_exchange_dropdown.CreateDrowdownGroup(a)}function PortfolioTable_Filter(){var a=portfolio_current_exchange?"#"+portfolio_current_exchange+"#":"",b=portfolio_datatable.columns()[0].length;portfolio_datatable.column(0).nodes().to$().each(function(){if($(this).find("i").length<=0){var a=$("<i class='flag-icon'></i>"),b=ProductMgr.get($(this).text()),c=b?b[tags.exchange]:"";a.addClass(ExchangeMgr.exchange_flag[c]||""),$(this).prepend(a)}}),portfolio_datatable.column(b-2).search(a,!1,!1,!1).draw(!1)}function PortfolioTable_Hint(a){if(a){var b=$("<table class='portfolio-hint'></table>");if(initial_data.views.trade.portfolio.tooltip)for(var c=0;c<initial_data.views.trade.portfolio.tooltip.length;c++){var d=initial_data.views.trade.portfolio.tooltip[c];if(d&&d.key){var e=$("<tr></tr>"),f=d.i18n||"portfolio_hint_"+d.key,g=messages[f]?messages[f].text:0,h=a[d.key];e.append("<td style='text-align:left; padding-right:20px; word-break: keep-all;white-space:nowrap;'>{0}</td>".format(g)),e.append("<td style='text-align:left; word-break: keep-all;white-space:nowrap;' data-format='{0}'>{1}</td>".format(d.format,h)),e.format(),b.append(e)}}return b.format(),b.html()}}function Portfolio_GetPositionObj(a){if(a){for(var b={},c=initial_data.views.trade.portfolio.schema.concat(initial_data.views.trade.portfolio.tooltip),d=0;d<c.length;d++){var e=c[d],f=a[e.key];b[e.key]="undefined"==typeof f?null:f}return $._setDefault(b),b}}var portfolio_panel,portfolio_table,portfolio_datatable,portfolio_current_exchange,portfolio_exchange_dropdown;