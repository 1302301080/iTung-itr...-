function Settlement_Initialize(){settlement_form=$("#settlement-form"),settlement_input_symbolCode=$(".productCode"),account=AccountMgr.current_account,payment_input=$("[name=payment_input]"),swiftCode=$(".cd-swift-code"),withBalance=$(".with-balance"),xQuantity=$("[name=x_quantity]"),scrip=$("[name=scrip]"),settlementWarningMessage=$("#settlement-warning-message"),$.get("/iTrader/message/detail",function(a){accountInfoList=a.accountInfoList,bankDetailList=a.bankDetailList,imageFile=a.imageFile,imageFile||($(".visible-CD-CQE").remove(),$(".visible-CDE").remove());var b=accountInfoList[account];for(var c in b){var d=b[c][0];b[c][1];$(".cw-select-bank").append($("<option>",{value:d,text:d}))}for(var e in bankDetailList){var f=bankDetailList[e];$(".cd-bank-name").append($("<option>",{value:f[0],text:f[0]}))}$("[name=payment_type]").change(function(){"DVP"==$(this).val()?(payment_input.removeAttr("readonly"),payment_input.attr("required","required")):(payment_input.attr("readOnly","readOnly"),payment_input.removeAttr("required"),$(this).parents(".has-error").removeClass("has-error"),payment_input.val(""))}),settlement_input_symbolCode.on("input",function(){$(this).val($(this).val().toUpperCase())}),settlement_input_symbolCode.blur(function(){var a=$("input:radio[name='instruction']:checked").val(),b=$("input:radio[name='method']:checked").val(),c=this;$(c).val(applyProductRule($(c).val()));var d=$(c).val();$(".sd-productName").val(""),$(".si-productName").val(""),$(".si-holding").val(""),$(".pw-productName").val(""),$(".pw-holding").val(""),$.get("/iTrader/product?symbol="+d+"&ISINCode=1",function(d){var e=d.data;if(e){var f=e.symbolName,g=e[0],h=GetMaxSellSync(g);if($(c).val(g),"SD"==a)$(".sd-productName").val(f);else{if(IsOTCBond(e)||IsOTCFund(e))return void settlementWarningMessage.text(messages.settlement_product_warning.text);"SI"==b?($(".si-productName").val(f),$(".si-holding").val($._format.quantity(h))):($(".pw-productName").val(f),$(".pw-holding").val($._format.quantity(h)))}settlementWarningMessage.text("")}else settlementWarningMessage.text(messages.settlement_product_warning.text)})}),$(".cw-currency").change(function(){var a=$(this).find("option:selected").val(),b=AccountMgr.get(account,a);a&&("multi"===CurrencyMgr.currencyMode&&b[23]!=a&&(b[700]=0),b[700]||0===b[700]?(withBalance.text(a+" "+$._format.amount(b[700])),withBalance.parents(".detail").removeClass("hidden")):withBalance.parents(".detail").addClass("hidden"))}),$(".cd-currency").change(function(){var a=$(this).find("option:selected").val(),b=AccountMgr.get(account,a),c=initial_data.keyTags.cashBalance,d=initial_data.keyTags.tradingLimit;"multi"===CurrencyMgr.currencyMode&&b[23]!=a&&(b[c]=0),$(".cashBalance").text(a+" "+$._format.amount(b[c])),$(".pur-stock").text(a+" "+$._format.amount(b[d])),b[1206]||0===b[1206]?($(".pur-fullTrade").text(a+" "+$._format.amount(b[1206])),$(".pur-fullTrade").parents(".help-block").removeClass("hidden")):$(".pur-fullTrade").parents(".help-block").addClass("hidden")}),$(".cw-select-bank").change(function(){var a=$(this).find("option:selected").val();if(accountInfoList[account]){var b=accountInfoList[account][a][1];$(".cw-bank-number").val(b)}}),$(".cd-bank-name").change(function(){var a=$(this).find("option:selected").val(),b=bankDetailList[a];if(b){var c="",d=$("html").attr("lang");c="en-US"==d?b[4]:"zh-CN"==d?b[5]:b[6],$(".cd-alias-name").text(c),b[1]?(swiftCode.text(b[1]),swiftCode.parent().removeClass("hidden")):swiftCode.parent().addClass("hidden"),$(".cd-ac-number").text(b[2]),$(".cd-ac-name").text(b[3])}}),scrip.change(function(){$(this).val()?xQuantity.attr("required",!0):xQuantity.attr("required",!1)}),xQuantity.change(function(){$(this).val()?scrip.attr("required",!0):scrip.attr("required",!1)})}),$(".form-datetime").datepicker({format:"dd/mm/yyyy",autoclose:!0,startDate:"today",todayHighlight:!0}),$($("[name=instruction]")[0]).attr("checked",!0),SettlementSelectChanged(),$("[name=instruction]").change(function(){var a=$("input:radio[name='method']:checked");a&&a.length>0&&a.attr("checked",!1),SettlementSelectChanged()}),$("[name=method]").change(function(){SettlementSelectChanged()}),settlement_form.translate()}function applyProductRule(a){if(initial_data.exchange_rule&&initial_data.exchange_rule.SEHK){var b=initial_data.exchange_rule.SEHK;b.rule=b.rule||"default",b.rule&&exchangeRules[b.rule]&&(a=exchangeRules[b.rule](a,b.options))}return a}function SettlementSelectChanged(){settlementWarningMessage.text(""),$(".settlement_method").each(function(){$(this).addClass("hidden")}),$(".settlement_detail").each(function(){$(this).addClass("hidden")}),$(".special_detail").each(function(){$(this).addClass("hidden")});var a=$("input:radio[name='instruction']:checked");if(a&&a.length>0){$("#settlement_method_"+a.val()).removeClass("hidden");var b=$("input:radio[name='method']:checked");b&&b.length>0&&(element_method=$("#settlement_detail_"+a.val()+"_"+b.val()),(!element_method||element_method.length<=0)&&b.val().indexOf("E")>-1&&"CD"==a.val()&&(element_method=$("#settlement_detail_CDE")),(!element_method||element_method.length<=0)&&(element_method=$("#settlement_detail_"+a.val())),(!element_method||element_method.length<=0)&&(element_method=$("#settlement_detail_SD_SW_"+b.val())),(!element_method||element_method.length<=0)&&(element_method=$("#settlement_detail_CD_CW")),(!element_method||element_method.length<=0)&&(element_method=$("#settlement_detail_SD_SW")),element_method.removeClass("hidden")),$(".cd-currency").trigger("change"),$(".cw-select-bank").trigger("change"),$(".cw-currency").trigger("change"),$(".cd-bank-name").trigger("change"),$($(element_method).find(".visible-"+a.val()+"-"+b.val())).removeClass("hidden")}}function fileChange(a){if(a.value){var b=[".jpg",".jpeg",".png"],c=a.value;if(settlementWarningMessage.text(""),!c)return!1;var d=!1,e=c.substring(c.indexOf("."));if(b&&b.length>0)for(var f=0;f<b.length;f++)if(b[f].toUpperCase()==e.toUpperCase()){d=!0;break}return d?void 0:(settlementWarningMessage.text(messages.settlement_file_check.text),a.value="",!1)}}function SettlementInstruction(){showMessage({title:messages.settlement_instruction_title.text,closeByBackdrop:!1,load:{url:"/iTrader/message/settlement",callback:function(){Settlement_Initialize()}},buttonNameList:["submit","reset","close"],callback:function(a,b){if("submit"===a.name){var c=element_method.find("[name=amount]").val().replace(/,/g,""),d=element_method.find("[name=scrip]").val(),e=element_method.find("[name=x_quantity]").val();if(c&&d&&e&&c!=d*e)return void settlementWarningMessage.text(messages.settlement_SW_check.text);if(settlementWarningMessage.text(""),validateForm(settlement_form,{submitHandler:function(a){var c=new FormData(settlement_form[0]);c.append("account",account),b.close(),$.ajax({type:"post",url:"/iTrader/message/settlement",data:c,cache:!1,processData:!1,contentType:!1,success:function(a){a?a.error?handleError(a.error):alertMessage({message:messages.settlement_message_success.text+a.data.messageRefId}):handleError()},error:handleError})},validClass:""}),settlement_form.valid())if(a.text()===messages.btn_submit.text){a.text(messages.btn_sure.text),$("#settlement-form .alert").removeClass("hidden"),$("#settlement-form :input").attr("disabled","disabled");var f=b.getButton("btn-reset");f&&f.length>0&&f.text(messages.btn_cancel.text)}else a.text()===messages.btn_sure.text&&($("#settlement-form .hidden").remove(),$("#settlement-form :input").removeAttr("disabled"),settlement_form.submit(),b.close())}else if("reset"===a.name){if(a.text()===messages.btn_reset.text)document.getElementById("settlement-form").reset(),$("[name=instruction]").trigger("change"),$("[name=method]").trigger("change"),settlement_form.find(".has-success, .has-error").each(function(){$(this).removeClass("has-success").removeClass("has-error")});else if(a.text()===messages.btn_cancel.text){$("#settlement-form .alert").addClass("hidden"),$("#settlement-form :input").removeAttr("disabled");var f=b.getButton("btn-reset");f&&f.length>0&&f.text(messages.btn_reset.text);var g=b.getButton("btn-submit");g&&g.length>0&&g.text(messages.btn_submit.text)}}else"close"===a.name&&b.close()}})}var settlement_form,accountInfoList={},bankDetailList={},imageFile,account,element_method,settlement_input_symbolCode,payment_input,swiftCode,withBalance,xQuantity,scrip,settlementWarningMessage;