function setToArray(a,b,c){if(a&&b)for(var d=0;d<a.length;d++){for(var e=-1,f=0;f<b.length;f++)c&&b[f][c]==a[d][c]&&(e=f);e>=0?b[e]=a[d]:b.push(a[d])}}var OrderMgr={orders:{},callbackList:[],get:function(a){for(var b in this.orders){var c=this.orders[b];if(c[6]==a)return c}},set:function(a){if(a){for(var b=[],c=0;c<a.length;c++){var d=a[c];if(d&&d._id){d.switchID&&(d._id=d.switchID);var e=this.orders[d._id]||{};this.orders[d._id]=this.orders[d._id]||{};for(var f in d)e[f]=d[f];this.parse(d,e),this.orders[d._id]=e,b.push(this.orders[d._id])}}for(var c=0;c<this.callbackList.length;c++){var g=this.callbackList[c];g(b)}return a}},on:function(a){if("function"==typeof a){var b=[];for(var c in this.orders)b.push(this.orders[c]);a(b),this.callbackList=this.callbackList||[],this.callbackList.push(a)}},parse:function(a,b){if(a){b||(b=a);var c={11:a[11]},d=a[11];return"cash"===a.voucherType?d="1"==c[11]?2:3:"security"===a.voucherType&&(d="1"==c[11]?3:2),b[25]=a[25],b[11]=$._map.side(d),b[5]=$._map.status(a[5]),b[400]=$._map.source(a[400]),b.symbolName=GetSymbolName(a),b.shortName=GetShortSymbolName(a),b.options=GetOptions(b),"cash"!==b.voucherType?b[3]=getDisplayPrice(b[3],"order",a):b[3]=$._format.amount(a[3]),b[42]=getDisplayPrice(b[42],"avg",a),"cash"===a.voucherType?b[3]=a[3]:IsOTCFund(a)?(0==c[11]?(b[3]=$._format.amount(a[3]),b[4]=Number.NaN,b[11]=$._map.side(4)):(b[3]=Number.NaN,b[11]=$._map.side(5)),b.investAmount&&0==b.investAmount||(b.investAmount=Number.NaN),a.switchID&&(b[6]=a.switchID,b[11]=$._map.side(6),b[4]=Number.NaN,b[3]=Number.NaN,b.investAmount=Number.NaN,b[0]=messages.NotApplicableValue.text,b[23]=messages.NotApplicableValue.text,b.FundSwitchOrderList=b.FundSwitchOrderList)):IsOTCBond(a)&&(b[3]=$._format.price(a[3],"#,##0.00######")),b}}},ErrorOrderMgr={errorList:[],callbackList:[],set:function(a){if(a&&!(a.length<=0)){this.errorList=a;for(var b=0;b<this.callbackList.length;b++){var c=this.callbackList[b];c(a)}}},on:function(a){"function"==typeof a&&(this.errorList&&this.errorList.length>0&&a(this.errorList),this.callbackList=this.callbackList||[],this.callbackList.push(a))}},PositionMgr={positions:{},pendingPositions:[],lastMessageDatetime:null,callbackList:[],init:function(){var a=this;setInterval(function(){if(a.lastMessageDatetime=a.lastMessageDatetime||(new Date).getTime(),a.pendingPositions&&!(a.pendingPositions.length<=0)&&(new Date).getTime()-a.lastMessageDatetime>500){for(var b=0;b<a.callbackList.length;b++){var c=a.callbackList[b];c(a.pendingPositions)}a.pendingPositions=[]}},500)},get:function(a){a=a||{};var b=[];for(var c in this.positions){var d=this.positions[c]._raw;a.account&&a.account!==d[10]||a.symbol&&a.symbol!==d[0]||a.exchange&&a.exchange!==d[20]||b.push(this.positions[c])}return b},set:function(a){if(a&&!(a.length<=0)){for(var b=0;b<a.length;b++){var c=a[b];if(c&&c._id){this.positions[c._id]=this.positions[c._id]||{};for(var d in c)this.positions[c._id][d]=c[d];this.positions[c._id][31]=getDisplayPrice(c[31],"market",c),this.positions[c._id].costPrice=getDisplayPrice(c.costPrice,"avg",c),this.positions[c._id].marketValue=c.marketValue===Number.MIN_SAFE_INTEGER?Number.NaN:c.marketValue,this.positions[c._id].acceptValue=c.acceptValue===Number.MIN_SAFE_INTEGER?Number.NaN:c.acceptValue,this.positions[c._id].market=$._map.exchange(c[20]);var e=c[10];IsMarginAccount(e)?c.acceptValue==Number.NaN&&(this.positions[c._id].acceptValue=0):initial_data.forceShowAcceptValue||(this.positions[c._id].acceptValue=Number.NaN),this.pendingPositions.push(this.positions[c._id])}}AccountMgr.updateAcctInfo()}},on:function(a){if("function"==typeof a){var b=[];for(var c in this.positions)b.push(this.positions[c]);a(b),this.callbackList=this.callbackList||[],this.callbackList.push(a)}}};PositionMgr.init();var ExchangeMgr={current_exchange:"",exchanges:[],exchange_flag:{},exchange_orderType:{},exchange_tif:{},exchange_isDayTrade:{},exchange_isPriceQuote:{},exchange_isAShare:{},callbackList:[],set:function(a){if(a){for(var b in a){var c=a[b];c&&(this.exchange_flag[b]=c.icon||"",this.exchange_orderType[b]=c.type||[],this.exchange_tif[b]=c.tif||[],this.exchange_isDayTrade[b]=c.isDayTrade,this.exchange_isAShare[b]=c.isAShare,this.exchange_isPriceQuote[b]=c.isPriceQuote,this.exchanges.indexOf(b)<0&&this.exchanges.push(b))}for(var d=0;d<this.callbackList.length;d++){var e=this.callbackList[d];e({exchanges:this.exchanges})}}},on:function(a){"function"==typeof a&&(a({exchanges:this.exchanges}),this.callbackList=this.callbackList||[],this.callbackList.push(a))}},CurrencyMgr={currencyMode:"",base_currency:"",currency_list:[],get:function(a){for(var b=0;b<this.currency_list.length;b++)if(this.currency_list[b].currency===a)return this.currency_list[b]},set:function(a){if(a&&!(a.length<=0))for(var b=0;b<a.length;b++){var c=a[b];c.currency_list&&setToArray(c.currency_list,this.currency_list,"currency")}},setInfo:function(a){a&&(this.currencyMode=a.currencyMode,this.base_currency=a.baseCurrency,this.set(a.currencList))}},AccountMgr={current_account:"",account_list:[],account_info_list:{},account_balance_list:[],BCAN:[],callbackList:[],get:function(a,b){var c=_.find(this.account_balance_list,function(c){return c.account===a&&c.currency===b}),d=_.find(this.account_balance_list,function(b){return b.account===a&&null===b.currency});if(d&&b&&"single"===CurrencyMgr.currencyMode){var e={};$.extend(e,d.data);for(var f in e)"number"==typeof e[f]&&e[f]!=Number.NaN&&CurrencyMgr.get(b)&&(e[f]=e[f]/(CurrencyMgr.get(b).ratio||1));return e}return c?c.data:d?d.data:null},set:function(a){if(a&&!(a.length<=0))for(var b=0;b<a.length;b++){var c=a[b];if(c[1120]&&(c.interestAccrualWithDate=c[1120],c[1121]&&!isNaN(c[1121]))){var d=moment(24*(c[1121]-25569)*60*60*1e3).format("DDMMM");c.interestAccrualWithDate+="({0})".format(d)}var e;"undefined"!=typeof c.account_list?(this.account_list=c.account_list,this.account_info_list=c.account_info_list,this.account_multi_currency_CB=c.account_multi_currency_CB):(e={_id:c[10]+"#"+c[23],account:c[10],currency:c[23],base:CurrencyMgr.base_currency,data:c},setToArray([e],this.account_balance_list,"_id"));for(var f=0;f<this.callbackList.length;f++){var g=this.callbackList[f];g({account_list:c.account_list,account_info_list:c.account_info_list,account_multi_currency_CB:c.account_multi_currency_CB,balance:e})}}},setAcctInfo:function(a){if(a){this.account_list=a.accounts||[],this.account_info_list=a.accountsInfo,this.account_multi_currency_CB=a.accountMultiCurrencyCB,this.BCAN=a.BCAN;for(var b=0;b<this.callbackList.length;b++){var c=this.callbackList[b];c({account_list:this.account_list,account_info_list:this.account_info_list,account_balance_list:this.account_balance_list})}}},updateAcctInfo:function(){for(var a=0;a<this.account_balance_list.length;a++){var b=this.account_balance_list[a];b=b.data;for(var c=(b[10],0),d=0,e=0,f=0,g=0,h=0,i=!1,j=!1,k=PositionMgr.get(),l=0;l<k.length;l++){var m=k[l];if(m[10]===b[10]){var n=0;if(b[23])b[23]==m[23]&&(n=1);else{var o=CurrencyMgr.get(m[23]);n=o?o.ratio:1}if(c+=(m.unrealizedPL||0)*n,d+=(m.realizedPL||0)*n,g+=(m.marketValue||0)*n,h+=(m.acceptValue||0)*n,m.trades)for(var p in m.trades){var q=m.trades[p];"security"!==q.voucherType&&(0==q[tags.side]?e+=q[tags.price]*q[tags.quantity]*n:1==q[tags.side]&&(f+=q[tags.price]*q[tags.quantity]*n))}i||isNaN(m.marketValue)||(i=!0),j||isNaN(m.acceptValue)||(j=!0)}}b.cashBalance=b[initial_data.keyTags.cashBalance]||0,b.tradingLimit=b[initial_data.keyTags.tradingLimit]||0,b.marketValue=g,b.acceptValue=h,b.unrealizedPL=c,b.realizedPL=d,b.totalBuy=e,b.totalSell=f,b.totalNet=b.totalSell-b.totalBuy,b["-totalNet"]=-b.totalNet,b.totalBuySell=Math.abs(b.totalBuy)+Math.abs(b.totalSell),b.totalPortfolioValue=b.cashBalance+g,b.netAssetValue=b.totalPortfolioValue,initial_data.bankBalanceMode&&(b.tradingLimit>=0?b.netAssetValue=b.tradingLimit+(b.bankBalance||0)||0:b.netAssetValue=b.bankBalance||0),i||(b.marketValue=Number.NaN),j||(b.acceptValue=Number.NaN)}},on:function(a){"function"==typeof a&&(a({account_list:this.account_list,account_info_list:this.account_info_list,account_balance_list:this.account_balance_list}),this.callbackList=this.callbackList||[],this.callbackList.push(a))}},ProductMgr={products:{},get:function(a,b){if(a){b=b||function(){};var c=this;return this.products[a]?b(this.products[a]):void $.get("/iTrader/product?symbol="+a,function(a){var d=a.data;return d&&d[0]?(c.products[d[0]]=d,b(d)):b()})}}},SpreadMgr={spreadList:{},set:function(a){if(a&&!(a.length<=0))for(var b=0;b<a.length;b++){var c=a[b];c[0]&&c[73]&&(this.spreadList[c[0]]=c[73].split(","))}},getSpreadValue:function(a,b){var c="",d=1,e="";"object"==typeof a?(e=a[73]||a.spread,d=a[1504]||a.displayRatio||1):"string"==typeof a&&(e=a),b/=d;var f=this.spreadList[e];if(f){for(var g=0;g<f.length;g+=2)if(Number(f[g])>b){c=f[g+1];break}c=c||f[f.length-1]||.001}return Number(c*d).toString()},getSpreadPrecision:function(a,b){var c=this.getSpreadValue(a,b);return c?(c=Number(c).toString(),c.length-c.indexOf(".")-1):3}},MarginMgr={marginList:[],callbackList:[],get:function(a,b){return _.find(this.marginList,function(c){return c[tags.symbol]===b&&c[tags.account]===a})},set:function(a){if(a)return a[tags.symbol]&&a[tags.account]&&(_.remove(this.marginList,function(b){return b[tags.symbol]===a[tags.symbol]&&b[tags.account]===a[tags.account]}),this.marginList.push(a)),a}};