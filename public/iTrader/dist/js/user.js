function InitializeLogin(){login_form=$("#login-form"),login_username=$("#login-username"),login_password=$("#login-password"),login_submit=$("#login-submit"),login_alert=$("#login-alert"),login_alert_message=$("#login-message"),validateForm(login_form,{submitHandler:function(a){var b=login_submit.val();if("pin"===b)VerifyPIN();else if("token"===b)VerifyToken();else if("requestOTP"===b){var c=$("#phonemail-listCode"),d=c.find("select"),e=d.find("option:selected").val();d.change(function(){e=$(this).val()}),HandleRequest(e)}else Login()}}),ForgetPassword(),login_username.InputAutoUpper(),InitializePin(),$(document).translate()}function InitializePin(){$(".pin-input").keypress(function(){setTimeout(function(){$(".pin-input.active").each(function(){if(!$(this).val())return $(this).focus(),!1;if($(this).val().length>1){var a=$(this).val();$(this).val(a.substr(a.length-1,1))}})}.bind(this),1)}),$(".pin-input").focus(function(){$(this).val("")})}function Login(){login_submit.attr("disabled","disabled"),getClientIP(function(a,b){$.ajax({type:"post",url:"/iTrader/user/login",data:login_form.serialize()+(a?"&clientIP="+a:"")+(b?"&location="+b:""),success:function(a){if(login_submit.removeAttr("disabled"),a)if(a.error){var b=a.error,c=b[tags.errorCode]||b[tags.minorCode]||b.errorCode,d=messages.error["SSMITSERR_"+c]||messages.error[c]||b[tags.freeText];b.sessionID?seajs.use("password",function(a){a.change({sessionID:b.sessionID},function(a){login_password.val(a.password),login_form.submit()})}):(login_alert.removeClass("hidden"),login_alert_message.text(d),$(".captcha-group img").trigger("click"))}else if(a&&a.data){sessionObj=a.data,sessionObj[130]&&"0"==sessionObj[130]&&(console.log(sessionObj),seajs.use("dialog",function(a){a.showMessage({title:messages.login_2FA_registration_title.text,closable:!1,closeByBackdrop:!1,closeByKeyboard:!1,buttonNameList:["relogin","resend"],message:function(){var a=$("<div>",{"class":"col-lg-12 col-md-12 col-xs-12"}),b=$("<p>",{"class":""});b.append(messages.login_2FA_registration_message_eBrokerKey.text.format(maskEmailPhone(sessionObj[81])));var c="<p>"+messages.login_2FA_registration_message_time.text.format(maskEmailPhone(sessionObj[131]))+"</p>";return b.append(c),a.append(b),a},callback:function(a){"relogin"===a.name&&(window.location.href="/iTrader/user/logout"),"resend"===a.name&&seajs.use("cregistrationFA",function(a){a.InitResendBtn(sessionObj.sessionID)})}})}));var e=sessionObj[78];e?(isNewMode=!0,switchTo(e)):(isNewMode=!1,sessionObj[116]?HandlePINToken():PassLogin())}},error:function(a,b){login_submit.removeAttr("disabled"),handleError(a,b)}})})}function HandlePINToken(){PassOneStep(),login_alert.addClass("hidden"),login_alert_message.text(""),login_submit.text(messages.login_btn_pin.text),login_submit.val(isNewMode?"token":"pin");var a=$("#verify-pin");a.removeClass("hidden"),pinArray=sessionObj[116].split(","),$(".pin-help-text").each(function(){$(this).text($(this).text())});for(var b=0;b<pinArray.length;b++){var c=Number(pinArray[b])-1;$($(".pin-input")[c]).addClass("active").removeAttr("disabled").css("visibility","visible"),$($(".pin-help-text")[c]).css("visibility","visible")}$(".pin-input.active:first").focus(),TransformTokenType(a)}function HandleEmailToken(){for(var a=300,b=[],c=200;c<a;c++)sessionObj[c]&&b.push(sessionObj[c]);if(b.length>1)HandleMultiToken(b);else{PassOneStep(),login_submit.text(messages.login_btn_email.text),login_submit.val("token");var d=$("#verify-email-code");tokenCode=d.find("input"),sessionObj&&sessionObj[81]&&$("#login-email-address").text("({0})".format(maskEmailPhone(sessionObj[81]))),InitResendOTP(d),TransformTokenType(d)}}function HandleMultiToken(a){var b=$("#phonemail-listCode"),c=$("#login-submit"),d=b.find("select");c.addClass("requestOTP"),c.val("requestOTP"),c.text(messages.login_btn_requestOTP.text),b.removeClass("hidden"),d.empty();for(var e in a)d.append("<option value='"+a[e]+"'>"+maskEmailPhone(a[e])+"</option>")}function HandleSMSToken(){for(var a=300,b=[],c=200;c<a;c++)sessionObj[c]&&b.push(sessionObj[c]);if(b.length>1)HandleMultiToken(b);else{PassOneStep(),login_submit.text(messages.login_btn_sms.text),login_submit.val("token");var d=$("#verify-SMS-code");tokenCode=d.find("input"),sessionObj&&sessionObj[81]&&$("#login-phone-number").text("({0})".format(maskEmailPhone(sessionObj[81]))),InitResendOTP(d),TransformTokenType(d)}}function HandleRequest(a){if(a){var b={tokenType:sessionObj[78]||"",sessionID:sessionObj.sessionID,valueBak:a};$("#phonemail-listCode").addClass("hidden"),PassOneStep(),login_submit.text(messages.login_btn_token.text),login_submit.val("token");var c=a.indexOf("@");if(c>-1){b.notifyNumber=a;var d=$("#verify-email-code");tokenCode=d.find("input"),$("#login-email-address").text("({0})".format(maskEmailPhone(a)))}else{var e=a.indexOf("-");b.countryCode=a.substr(0,e),b.notifyNumber=a.substr(e+1);var d=$("#verify-SMS-code");tokenCode=d.find("input"),$("#login-phone-number").text("({0})".format(maskEmailPhone(a)))}reqOTPData=b,requestOTP(),InitResendOTP(d)}}function requestOTP(){reqOTPData&&$.ajax({type:"post",url:"/iTrader/security/requestOTP",data:reqOTPData,success:function(a){$(".login-messageid").text(""),$(".login-sendtime").text(""),$(".login-phone-resendtime").text(""),a&&a.data?(a.data[33]&&$(".login-sendtime").text(messages.login_verify_SMS_remark_time.text+" ({0})".format(a.data[33])),a.data[90]&&($(".login-resendtime").text(messages.login_verify_SMS_remark_resendtime.text+" ({0})".format(a.data[90])),Number(a.data[90])<=0&&$(".resend-btn").css("cursor","not-allowed").attr("disabled","disabled")),a.data[91]&&$(".login-messageid").text(messages.login_verify_SMS_remark_messageid.text+" ({0})".format(a.data[91]))):(a&&a.error&&a.error[39]&&(a.error[39]="SSMITSERR_"+a.error[39]),handleError(a.error))},error:handleError})}function TransformTokenType(a){if(a&&Number(sessionObj[85])&&sessionObj[85]!==sessionObj[78]){var b;if(b=isSecondaryType?sessionObj[78]:sessionObj[85],a.find(".isTransForm").remove(),messages["login_swichTokenType_"+b]&&messages["login_swichTokenType_"+b].text){var c=$("<a>",{text:messages["login_swichTokenType_"+b].text,href:"javascript:void(0)","class":"blue-link isTransForm",secondTokenType:b});a.find("p").append(c),c.click(function(){clearInterval(resendTimer),isSecondaryType=!isSecondaryType,a.addClass("hidden"),currentTokenType=c.attr("secondTokenType"),switchTo(currentTokenType),ResendOTP()})}}}function InitResendOTP(a){clearInterval(resendTimer);var b=5;a.removeClass("hidden"),b&&(a.find(".resend-btn").text(messages.login_resend_code.text+"({0}s)".format(b)).removeAttr("ready"),resendTimer=setInterval(function(){b--,b<=0?a.find(".resend-btn").text(messages.login_resend_code.text).attr("ready",!0):a.find(".resend-btn").text(messages.login_resend_code.text+"({0}s)".format(b)).removeAttr("ready")},1e3)),a.find(".resend-btn").click(function(){$(this).attr("ready")&&"disabled"!==$(this).attr("disabled")&&($(this).removeAttr("ready"),ResendOTP(),InitResendOTP(a))})}function ResendOTP(){if("2"==currentTokenType||"3"==currentTokenType){var a;a=isSecondaryType?GetPostData({secondTokenType:sessionObj[85]}):GetPostData(),$.ajax({type:"post",url:"/iTrader/security/resendOTP",data:a,success:function(a){$(".login-messageid").text(""),$(".login-sendtime").text(""),$(".login-phone-resendtime").text(""),a&&a.data?(console.log(a.data),a.data[33]&&$(".login-sendtime").text(messages.login_verify_SMS_remark_time.text+" ({0})".format(a.data[33])),a.data[90]&&($(".login-resendtime").text(messages.login_verify_SMS_remark_resendtime.text+" ({0})".format(a.data[90])),Number(a.data[90])<=0&&$(".resend-btn").css("cursor","not-allowed").attr("disabled","disabled")),$(".resend-btn").css("cursor","not-allowed").attr("disabled","disabled"),a.data[91]&&$(".login-messageid").text(messages.login_verify_SMS_remark_messageid.text+" ({0})".format(a.data[91]))):(a&&a.error&&a.error[39]&&(a.error[39]="SSMITSERR_"+a.error[39]),handleError(a.error))},error:handleError})}}function HandleToken(){PassOneStep(),login_submit.text(messages.login_btn_token.text),login_submit.val("token");var a=$("#verify-token-code");tokenCode=a.find("input"),a.removeClass("hidden"),TransformTokenType(a)}function HandleEBSToken(){PassOneStep(),login_submit.text(messages.login_btn_token.text),login_submit.val("token");var a=$("#verify-EBSToken-code");tokenCode=a.find("input"),a.removeClass("hidden"),VerifyEBSLogin(a),TransformTokenType(a)}function switchTo(a){switch(currentTokenType=a,a){case"-1":SelectHandle();break;case"0":PassLogin();break;case"1":HandlePINToken();break;case"2":HandleEmailToken();break;case"3":HandleSMSToken();break;case"4":HandleToken();break;case"5":HandleEBSToken()}}function ResendDactcode(a){var b={};b.sessionID=a,$.ajax({type:"post",url:"/iTrader/security/resendActCode",data:b,success:function(a){a&&a.error?(a&&a.error&&a.error[39]&&(a.error[39]="SSMITSERR_"+a.error[39]),handleError(a.error)):a&&a.data&&alert("ok!")},error:handleError})}function VerifyEBSLogin(a){$.ajax({type:"post",url:"/iTrader/user/login",data:GetPostData({type:"querylogin"}),success:function(a){if(a.error){if(75==a.error[39])return;a.error[39]&&(a.error.errorCode=a.error[39]),ShowErrorMessage(a.error),login_submit.text(messages.login_btn_verifyfail.text),login_submit.attr("isNeedRefresh",!0),login_submit.click(function(){var a=login_submit.attr("isNeedRefresh");a&&(window.location.href="/")})}else PassLogin()},error:function(a,b){VerifyEBSLogin()}})}function VerifyPIN(){!pinArray&&pinArray<1||($(".pin-input.active").each(function(){$(this).attr("disabled","disabled")}),login_submit.attr("disabled","disabled"),$.ajax({type:"post",url:"/iTrader/security/pin/verify",data:GetPostData(),success:function(a){login_submit.removeAttr("disabled"),a&&(a.error?ShowErrorMessage(a.error):PassLogin()),$(".pin-input.active").each(function(){$(this).removeAttr("disabled").val("")}),$(".pin-input.active:first").focus()},error:function(a,b){login_submit.removeAttr("disabled"),handleError(a,b)}}))}function VerifyToken(){tokenCode&&!tokenCode.val()||$.ajax({type:"post",url:"/iTrader/user/login",data:GetPostData({type:"verify"}),success:function(a){a&&(a.error?ShowErrorMessage(a.error):PassLogin())},error:function(a,b){login_submit.removeAttr("disabled"),handleError(a,b)}})}function ShowErrorMessage(a){if(a){a.errorCode&&(a.errorCode="SSMITSERR_"+a.errorCode);var b=getErrorMessage(a);b&&(login_alert.removeClass("hidden"),login_alert_message.text(b))}}function PassOneStep(){login_username.attr("readonly",!0),login_password.attr("readonly",!0),$(".captcha-group").addClass("hidden")}function SelectHandle(){if(sessionObj){var a={};a.sessionID=sessionObj.sessionID,a.cmd="regtoken",a.sessionObj=sessionObj,console.log(a),seajs.use("cregistrationFA",function(b){b.register2FA(a)})}}function PassLogin(){sessionObj&&(sessionStorage.clear(),sessionObj.pwdExpiryPromptDays>=0?seajs.use("dialog",function(a){a.alertMessage({message:messages.login_pwd_expiry_prompt.text.format(sessionObj.pwdExpiryPromptDays),onclose:function(a){a.close(),navigate("/iTrader/risk/disclosure")}})}):navigate("/iTrader/risk/disclosure"))}function GetPostData(a){var b="";if(pinArray&&pinArray.length>0)for(var c=0;c<pinArray.length;c++){var d=Number(pinArray[c])-1;b+=$($(".pin-input")[d]).val()+(c+1!==pinArray.length?",":"")}var e=login_form.serialize()+"&tokenType="+sessionObj[78];if(b&&(e+=(isNewMode?"&tokenCode=":"&pin=")+b),tokenCode&&(e+=tokenCode?"&tokenCode="+tokenCode.val():""),sessionObj&&sessionObj.sessionID&&(e+="&sessionID="+sessionObj.sessionID),a)for(var f in a)e+="&"+f+"="+a[f];return e}function getClientIP(a){if(a){var b=$("#login-get-client-ip-url").val();b?$.ajax({url:b,type:"GET",cache:!1,success:function(b){var c="",d="";if(b)if("object"==typeof b)c=b.ip||"",d=b.location||"";else{var e=b.indexOf("[")+1,f=b.indexOf("]"),g=b.lastIndexOf("[")+1,h=b.lastIndexOf("]");c=f>e&&e>0?b.substring(e,f):b,h>g&&g>0&&(d=b.substring(g,h))}a(c,d)},error:function(){a()}}):a()}}function ForgetPassword(){$("#login-forget-password").click(function(){var a=$(this).attr("data-url");seajs.use("password",function(b){b.reset({url:a},function(a){login_password.val(a.password),login_form.submit()})})})}var login_form,login_username,login_password,login_submit,login_alert,login_alert_message,pinArray,sessionObj,resendTimer,tokenCode,isNewMode=!1,isSecondaryType=!1,currentTokenType,sessionID,reqOTPData;$(function(){$.get("/iTrader/initialize/tags",function(a){tags=a,InitializeLogin();var b=$("#login-error-code").val();b&&handleError(b,function(){window.location.href="/"})})}),seajs.use("mobile",function(a){a.init()});