define(function(require,exports,module){function a(){z=$("#ticket-panel"),z.length<=0||(A=$("#ticket-form"),C=$("#ticket-select-exchange"),D=$("#ticket-input-price"),E=$("#ticket-input-quantity"),F=$("#ticket-input-symbol-code"),G=$("#ticket-input-sysbol-name"),H=$("#ticket-order-type"),I=$("#ticket-order-tif"),J=$("#ticket-gtd-addon"),K=$("#ticket-btn-buy-side"),L=$("#ticket-btn-sell-side"),R=$("#ticket-otc-flag"),ticket_search_btn=$("#ticket-search"),S=$(".bond-input-quantity"),F.blur(function(){c()}),C.change(function(){x(null,C.val()),v(),H.trigger("change"),I.trigger("change"),c()}),$("#ticket-search").click(function(){SearchProduct_Search(C.val(),null,{type:1})}),F.change(function(){N="",E.val(""),b()}),F.on("input",function(){$(this).val($(this).val().toUpperCase())}),D.blur(function(){j()}),H.change(function(){var a=H.val();"market"===a||"auction"===a?(D.attr("disabled","disabled"),b(),I.val("day"),I.attr("disabled","disabled"),I.trigger("change")):"auctionLimit"===a?(D.removeAttr("disabled"),b(D.val()),I.val("day"),I.attr("disabled","disabled"),I.trigger("change")):(D.removeAttr("disabled"),I.removeAttr("disabled"),b(D.val())),"stopLimit"===a?(H.parent("div").addClass("col-sm-6").removeClass("col-sm-12"),$("#ticket-stop-price-container").removeClass("hidden"),$("#ticket-input-stop-price").val("").focus()):(H.parent("div").addClass("col-sm-12").removeClass("col-sm-6"),$("#ticket-stop-price-container").addClass("hidden")),"specialLimit"===a?(I.find("[value=fak]").attr("disabled","disabled").setOptionVisible(!1),I.find("[value=fok]").attr("disabled","disabled").setOptionVisible(!1),I.get(0).selectedIndex=0):(I.find("[value=fak]").attr("disabled",!1).setOptionVisible(!0),I.find("[value=fok]").attr("disabled",!1).setOptionVisible(!0)),j()}),I.change(function(){I.val().indexOf("gtd")>=0?J.removeClass("hidden"):J.addClass("hidden")}),g(z),f(),k(),u(),x(null,C.val()),window.addEventListener("message",function(a){a.data&&"copy-symbol"===a.data.name&&(a.data.exchange&&w(a.data.exchange),d(a.data))},!1),$(".ticket-btn-reset").on("click",function(){i()}),AccountMgr.on(function(){setTimeout(function(){j()},500)}),PositionMgr.on(function(){j()}),ExchangeMgr.on(function(){e(),v(),H.trigger("change"),I.trigger("change")}),e(),v(),$(document).translate())}function b(a){return a=a||"",a=D.attr("disabled")?"0":"0"===a?"":a,D.val(a),D}function c(){current.symbol=F.val(),F.val(h(F.val())),N="",G.html(""),$("#ticket-lot-size").parent().addClass("hidden"),$("#ticket-max-buy-sell-hint").addClass("hidden"),$("#ticket-max-buy").text(""),$("#ticket_max_sell").text(""),$("#ticket-currency-hint").text("");var a=F.val();U.clear(),V.clear(),T=null,a&&(G.addClass("text-danger"),G.text(messages.ticket_message_invalid_symbol.text).attr("title",""),ProductMgr.get(a,function(b){if(b){if(b[20]){var c=ExchangeMgr.exchange_isAShare[b[20]],d=$(".account-BCAN");if(c){if(AccountMgr.BCAN){var e=$("<select>",{"class":"form-control act-BCAN",name:"BCAN"});e.css({padding:"0 10px",height:"22px","font-size":"12px","max-width":"120px"});var f=AccountMgr.BCAN;if(1==f.length)d.empty();else if(f.length>1){d.empty(),d.attr("class","account-BCAN"),d.css("display","inline-block");for(var g in f){var h=$("<option>",{value:f[g],text:messages.ticket_input_BCAN.text+" ["+f[g]+"]"});e.append(h)}d.append(e)}else d.empty()}}else d.empty(),d.attr("class","account-BCAN")}if(b[tags.symbol]!==F.val().trim())return;if(!ExchangeMgr.exchanges||ExchangeMgr.exchanges.indexOf(b[tags.exchange])<0)return;b[tags.exchange]!==C.val()&&w(b[tags.exchange]),N=a,G.removeClass("text-danger");var i=b.symbolName||b.shortName||"";G.text(i),G.attr("title",i),$("#ticket-currency-hint").text(b[tags.currency]||""),current.symbol=a,$("#ticket-lot-size").text($._format.quantity(b[tags.lotSize])).parent().removeClass("hidden"),$("#ticket-max-buy-sell-hint").removeClass("hidden"),j(),x(b),T=b,$(document).trigger("ticket-added",b)}}))}function d(a){"object"==typeof a&&(a.exchange&&w(a.exchange),F.val(a.symbol).focus(),a.symbol&&setTimeout(function(){F.trigger("blur"),b(a.price).focus(),"undefined"!=typeof a.quantity&&E.val(a.quantity).focus()},50))}function e(){W?C.find("option").each(function(){$(this).text($._map.exchange($(this).val()))}):$(".custom-options").selectric({disableOnMobile:!0,optionsItemBuilder:function(a,b,c){return'<i class="icon-margin flag-icon '+(ExchangeMgr.exchange_flag[a.value]||"")+'"></i>'+$._map.exchange(a.value)},labelBuilder:function(a){return'<i class="icon-margin flag-icon '+(ExchangeMgr.exchange_flag[a.value]||"")+'"></i>'+$._map.exchange(a.value)}})}function f(){$("#ticket-gtd-picker").datepicker({startDate:"today",todayHighlight:!0,autoclose:!0}).on("changeDate",function(){var a=$(this).datepicker("getDate");$("#ticket-gtd-option").text(messages.oms.order_tif_gtd_pre+" ["+moment(a).format("MM/DD/YY")+"]"),$("#ticket-gtd-option").val("gtd:"+moment(a).format("YYYY/MM/DD"))})}function g(a,b){a.find(".price-spinner:not(.spinner-done)").spinner({min:0,precision:10,step:function(a){var c=b||T;if(!c)return 0;var d=Number(SpreadMgr.getSpreadValue(c,this.oldValue));if(!d)return 0;var e;return"up"===a?(e=Math.ceil(this.oldValue/d)*d,Number(Math.abs(e-this.oldValue)<1e-4?d:e-this.oldValue).toString()):(e=Math.floor(this.oldValue/d)*d,Number(Math.abs(e-this.oldValue)<1e-4?d:this.oldValue-e).toString())}}).spinner("changing",function(a,c,d){var e=b||T;e&&($(this).val(getDisplayPrice(c,"order",e).replace(/,/g,"")),j())}),a.find(".price-spinner:not(.spinner-done) input").each(function(){var a=b||T;a&&$(this).val(getDisplayPrice($(this).val(),"order",a).replace(/,/g,""))}),a.find(".quantity-spinner:not(.spinner-done)").spinner({min:0,step:function(a){var c,d=b||T,e=(d?d[24]:0)||0;return"up"===a?(c=Math.ceil(this.oldValue/e)*e,Math.abs(c-this.oldValue)<1e-4?e:c-this.oldValue):(c=Math.floor(this.oldValue/e)*e,Math.abs(c-this.oldValue)<1e-4?e:this.oldValue-c)}}),a.find(".price-spinner:not(.spinner-done),.quantity-spinner:not(.spinner-done)").find("input").each(function(){Number($(this).val())||$($(this).val(""))}),a.find(".price-spinner:not(spinner-done) input").blur(function(){var a=b||T;if(a){var c=Number($(this).val());return isNaN(c)||0===c?void $(this).val(""):void $(this).val(getDisplayPrice(c,"order",a).replace(/,/g,""))}}),a.find(".price-spinner,.quantity-spinner").addClass("spinner-done")}function h(a){var b=C.val();if(initial_data.exchange_rule&&initial_data.exchange_rule[b]){var c=initial_data.exchange_rule[b];c.rule=c.rule||"default",c.rule&&exchangeRules[c.rule]&&(a=exchangeRules[c.rule](a,c.options))}return a}function i(){d({symbol:""}),c(),U.clear(),V.clear(),F.val(""),D.val(""),E.val(""),S.val(""),G.html("&nbsp;"),$("#ticket-gtd-option").text(messages.oms.order_tif_gtd),$("#ticket-gtd-option").val("gtd"),H.popover("hide"),v(),H.trigger("change"),I.trigger("change"),F.focus()}function j(){D.attr("disabled")||0==D.val()?$("#ticket-max-buy").text(""):GetMaxBuy(N,D.val(),function(a){$("#ticket-max-buy").text($._format.quantity(a))}),$("#ticket-max-sell").text($._format.quantity(GetMaxSellSync(N)))}function k(){K.click(function(){M=0,$("#ticket-side").val(0)}),L.click(function(){M=1,$("#ticket-side").val(1)}),validateForm(A,{submitHandler:function(a){if(T&&N){if(A.find("[name=symbol]").val()!=T[0])return void A.find("[name=symbol]").blur();if(0==M){if(K.attr("disabled"))return}else if(L.attr("disabled"))return;L.attr("disabled","disabled"),K.attr("disabled","disabled");var b=T[22],c=T[3407];if(B=$(a).serialize()+"&account={0}&productType={1}&transFee={2}".format(current.account,b,c),IsOTCFund(T))U.popupFundDisclaimer(function(a){a&&m(B,{confirmBoxTitle:messages.order_confirmation_fund_title.text}),l()});else if(IsOTCBond(T))V.popupBondDisclaimer(function(a){a&&m(B,{confirmBoxTitle:messages.order_confirmation_bond_title.text}),l()});else{var d=!0;initial_data.ticket&&initial_data.ticket.allowZeroPrice===!1&&(D.attr("disabled")||0!=Number(D.val())||(d=!1));var e=Number($("#ticket-input-stop-price").val());"stopLimit"===H.val()&&e<=0&&(d=!1),"gtd"!==I.val()||O||(d=!1),B+="&stopPrice="+e,d?m():l()}}},errorClass:"error",validClass:"success"})}function l(){K&&(K.removeAttr("disabled"),L.removeAttr("disabled"),initial_data.ticket.clearAfterSubmit&&i())}function m(a,b){B=a||B,b=b||{};var c={title:b.title};b.addOrder||(b.addOrder=p);for(var d=B.split("&"),e=0;e<d.length;e++){var f=d[e].split("=");c[f[0]]=f[1]}$.ajax({type:"post",url:"/iTrader/order/calculate",data:B,success:function(a){a.error?(n(a),handleError(a.error,function(){l()})):a.data&&(a.data.isNeedConfirm?(c.result=a.data.isNeedConfirm,c.confirmBoxTitle=b.confirmBoxTitle,o(c,function(c){c&&b.addOrder(a.data)})):b.addOrder(a.data))},error:function(a){handleError(a,function(){l()})}})}function n(a){if(a&&a.error){var b=a.error.errorCode;"DCFUND006"===b&&a.error.parameters&&a.error.parameters.length>0&&(a.error.parameters[0]=$._format.amount(a.error.parameters[0]))}}function o(a,b){function c(){if(!d||d.length<=0)return b(!0);var e=!1,f=d[0];if(d.splice(0,1),f&&f.errorCode){var g="";f.parameters&&f.parameters.length>1?"DCFUND013"===f.errorCode?g="<div>"+messages.error[f.errorCode].cformat($._format.amount(f.parameters[0]),$._format.amount(f.parameters[1]))+"</div>":"DCFUND009"===f.errorCode&&(g="<div>"+messages.error[f.errorCode].cformat(f.parameters[0],f.parameters[1])+"</div>"):"DCFUND014"===f.errorCode&&(g=messages.error.DCFUND014),showMessage({title:a.confirmBoxTitle||"",type:BootstrapDialog.TYPE_WARNING,buttonNameList:["sure","cancel"],message:g,onshown:function(){y()},callback:function(a,b){var c=a.attr("id");"btn-sure"===c&&(e=!0),b.close()},onhidden:function(){e?c():b(!1)}})}else c()}if(b=b||{},!a&&!a.data)return b(!0);var d=a.result;IsArray(d)||(d=[d]),c(b)}function p(a){a&&a[tags.userRef]&&!isNaN(a[tags.side])&&showMessage({title:messages.ticket_order_add_confirmation_title.text+AccountMgr.current_account,type:"0"==a[tags.side]?BootstrapDialog.TYPE_SUCCESS:BootstrapDialog.TYPE_DANGER,load:{url:"/iTrader/order/add?ref="+a[tags.userRef],callback:function(b){X.FormatOrderInfo(a[0],b.$modal)}},buttonNameList:["submit","close"],callback:function(a,b){if("close"===a.name)b.close();else if("submit"===a.name){var c=$("#add-order-form");validateForm(c,{submitHandler:function(){var a=c.find("[name=password]"),d=B+"&cmd=add";a.length>0&&(d+="&password="+a.val()),b.close(),s(d,function(a){a.error?handleError(a.error,function(){a.error.showCBBCAgreement&&showMessage({title:messages.dialog_cbbc_agreement_title.text,buttonNameList:["agree","reject"],load:{url:"/html/CBBCArgeement_"+lang+".html"},callback:function(a,b){var c=a.attr("id");"btn-reject"===c?b.close():"btn-agree"===c&&(b.close(),t())},onshow:function(a){a.getModalBody().css("max-height","450px")}})}):alertMessage({title:messages.dialog_information_title.text,message:messages.order_confirmation_order_submitted_message.text})})}}),c.valid()&&c.submit()}},onhidden:function(){l()}})}function q(a){var b=OrderMgr.get(a);b&&showMessage({title:messages.ticket_order_change_confirmation_title.text+b[tags.account],type:"0"==b[tags.side]?BootstrapDialog.TYPE_SUCCESS:BootstrapDialog.TYPE_DANGER,load:{url:"/iTrader/order/change?orderNo="+a,callback:function(a){current.symbol=$("#change-confirmation-symbol").attr("data-symbol"),$("#order-change-gtd").datepicker({startDate:"today",todayHighlight:!0,autoclose:!0,format:"yyyy/mm/dd"}),X.FormatOrderInfo(b[0],a.$modal,function(b){g(a.$modal,b)})}},buttonNameList:["submit","close"],callback:function(a,b){if("close"===a.name)b.close();else if("submit"===a.name){var c=$("#change-order-form");validateForm(c,{submitHandler:function(){var a=c.find("[name=changePrice]");if(!(a.length>1&&initial_data.ticket&&initial_data.ticket.allowZeroPrice===!1&&0==Number($(a[1]).val()))){var d=c.serialize()+"&cmd=change";b.close(),s(d,function(a){a.error?handleError(a.error):alertMessage({title:messages.dialog_information_title.text,message:messages.order_confirmation_order_change_submitted_message.text})})}}}),c.valid()&&c.submit()}},onhide:function(a){F&&(current.symbol=F.val())}})}function r(a){var b=OrderMgr.get(a);b&&showMessage({title:messages.ticket_order_cancel_confirmation_title.text+b[tags.account],type:"0"==b[tags.side]?BootstrapDialog.TYPE_SUCCESS:BootstrapDialog.TYPE_DANGER,load:{url:"/iTrader/order/cancel?orderNo="+a,callback:function(a){X.FormatOrderInfo(b[0],a.$modal)}},buttonNameList:["submit","close"],callback:function(a,b){if("close"===a.name)b.close();else if("submit"===a.name){var c=$("#cancel-order-form");validateForm(c,{submitHandler:function(){var a=c.serialize()+"&cmd=cancel";b.close(),s(a,function(a){a.error?handleError(a.error):alertMessage({title:messages.dialog_information_title.text,message:messages.order_confirmation_order_cancel_submitted_message.text})})}}),c.valid()&&c.submit()}},onhide:function(){F&&(current.symbol=F.val())}})}function s(a,b){$.ajax({type:"post",url:"/iTrader/order/submit",data:a,success:b,error:handleError})}function t(){$.ajax({type:"post",url:"/iTrader/message/agreement",data:{name:"SaveCBBCAgreementFlag",value:1,_csrf:$("[name=_csrf]").attr("value")},success:function(a){a.error&&layer.msg(getErrorMessage(a.error))},error:handleError})}function u(){function a(a,b){if(a){var c=Number(a);isNaN(c)?shortcut.add(a,b):shortcut.add("",b,{keycode:c})}}var b=initial_data.views.trade.ticket.shortcut;b&&b.enable&&(a(b.buy,function(){$("#ticket-side").val(0),M=0,A.submit()}),a(b.sell,function(){$("#ticket-side").val(1),M=1,A.submit()}),a(b.reset,function(){i()}),a(b.refresh,function(){}),a(b.tabUp,function(){var a=$(":focus");if(a&&a.length>0)for(var b=Number(a.attr("tabindex")),c=b;c>0;c--){var d=$("[tabindex="+(c-1)+"]");if(d.length>0&&!d.attr("disabled")){d.focus();break}}}),a(b.tabDown,function(){var a=$(":focus");if(a&&a.length>0)for(var b=Number(a.attr("tabindex")),c=b;c<=8;c++){var d=$("[tabindex="+(c+1)+"]");if(d.length>0&&!d.attr("disabled")){d.focus();break}}}))}function v(){function a(a,b){if(a&&b)for(var c=0;c<a.length;c++)if(0===$(a[c]).val().indexOf(b))return a[c]}P||(P=H.find("option")),Q||(Q=I.find("option"));var b=C.val();if(b&&ExchangeMgr&&ExchangeMgr.exchange_orderType[b]&&ExchangeMgr.exchange_tif[b]){H.find("option").remove();for(var c=0;c<ExchangeMgr.exchange_orderType[b].length;c++){var d=ExchangeMgr.exchange_orderType[b][c];H.append(a(P,d)||"")}H.get(0).selectedIndex=0,I.find("option").remove();for(var c=0;c<ExchangeMgr.exchange_tif[b].length;c++){var e=ExchangeMgr.exchange_tif[b][c];I.append(a(Q,e)||"")}I.get(0).selectedIndex=0}}function w(a){a&&(C.val(a),$(".custom-options").selectric("refresh"),C.trigger("change"))}function x(a,b){$(".ticket-mode-stock,.ticket-mode-bond,.ticket-mode-fund,.ticket-mode-disabled-fund,.ticket-mode-disabled-bond").addClass("hidden"),IsOTCFund(a)||"FUND"===b?(initial_data.views.trade.ticket.disableFundTicket?$(".ticket-mode-disabled-fund").removeClass("hidden"):$(".ticket-mode-fund").removeClass("hidden"),R.val(1)):IsOTCBond(a)||"BOND"===b?(initial_data.views.trade.ticket.disableBondTicket?$(".ticket-mode-disabled-bond").removeClass("hidden"):$(".ticket-mode-bond").removeClass("hidden"),R.val(1)):($(".ticket-mode-stock").removeClass("hidden"),R.val(0)),F.val()||F.focus()}function y(){var a=$("[required-accept-disclosure]").parents(".modal-content").find("#btn-sure");a.attr("disabled",!0),$("[required-accept-disclosure]").click(function(){var b=$(this).get(0).checked;a.attr("disabled",!b)})}var z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U=require("fund-ticket"),V=require("bond-ticket"),W=require("mobile").GetIsMobile(),X=(require("full-trade"),require("util"));a(),U.init(initial_data.ticket),V.init(initial_data.ticket),exports.init=a,exports.inputSymbol=d,exports.calcOrder=k,exports.addOrder=p,exports.changeOrder=q,exports.cancelOrder=r,exports.submitCalcorder=m});