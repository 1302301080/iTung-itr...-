define(function(require,exports,module){function a(){function a(a,b,c){var d=$("<div>");if(!a||!b||!c||c.length<=0)return d;for(var e={id:a,name:{i18n:b,name:b},data:[]},f=0;f<c.length;f++)e.data.push({key:c[f],value:"ALL"===c[f]?messages.ALL.text:c[f]});return d.CreateDrowdownGroup(e),d.children("div").css("margin-right","8px"),d}for(var b=n.account_list||[],d=[],e={},f=0;f<o.currency_list.length;f++)o.currency_list[f].currency&&d.push(o.currency_list[f].currency);for(var g=0;g<n.account_balance_list.length;g++){var h=n.account_balance_list[g];h.account&&h.currency&&(e[h.account]||(e[h.account]=["ALL"]),e[h.account].push(h.currency))}p=$("<table>",{"class":"table table-bordered table-hover table-condensed table-striped"}).append($("<thead>")).append($("<tbody>"));var l=a("cashview-select-account","column_account",b.length>1?b:[]),m=a("cashview-select-currency","column_currency",e[b[0]]),q=a("cashview-select-equal-currency","cashview_equal_currency",d);k=$("<div>",{"class":"row"}),j.append(k);var r=$("<div>",{"class":"col-md-12"});k.append(r),r.append(l.children()).append(m.children()).append(q.children()).append(p),w.account=b.length>0?b[0]:"",w.currency=e[w.account]?e[w.account][0]:o.base_currency,w.equalCurrency=d[0],$("#cashview-select-account").on("change",function(b,d){w.account=d,w.currency="ALL",$("#cashview-select-currency").replaceWith(a("cashview-select-currency","column_currency",e[d]).children()),$("#cashview-select-currency").on("change",function(a,b){w.currency=b,c()}),c()}),$("#cashview-select-currency").on("change",function(a,b){w.currency=b,c()}),$("#cashview-select-equal-currency").on("change",function(a,b){w.equalCurrency=b,c()}),i($("#cashview-select-currency"))}function b(){q=p.CreateDatatable({columnSchema:m,columnHeaderPrefix:"cashview_header_",searching:!1,paging:!1,info:!1,ordering:!1})}function c(){n.updateAcctInfo(),q.clear().draw();for(var a,b=w.account,c=w.currency,i=w.equalCurrency,j=[[],[],[]],k=0;k<n.account_balance_list.length;k++){var l=n.account_balance_list[k];if(l.account&&!(b&&l.account!=b||c&&"ALL"!=c&&c!=l.currency)){var m;if(null==l.currency&&"ALL"===c)m=d(l,i),m.DT_RowId=r+"-group",m[23]="{0}({1})".format(messages.cashview_group_column.text,i),j[1].push(m);else{a=a||l,m=d(l);var p=o.get(l.currency);p&&(p.isConvertible?j[0].push(m):j[2].push(m))}m.exchangeRatio=f(l.currency,i)}}h(j[0]),h(j[2]);for(var s=d(),u=0;u<j.length;u++)for(var v=0;v<j[u].length;v++){var x=j[u][v];if(x){if(0===u||2===u)for(var z in x)isNaN(x[z])||t.indexOf(z)>=0||(s[z]=s[z]||0,s[z]+=Number(x[z]*(x.exchangeRatio||1)));1!==u&&(y.HandleZeroShowNA(x),q.UpdateRowData(x))}}if("ALL"===c)s.DT_RowId=r+"-total",s.exchangeRatio="",s[23]="{0}({1})".format(messages.cashview_total_column.text,i),e(s,b),y.HandleZeroShowNA(s),q.UpdateRowData(s);else if(a&&c!==i){var A=d(a,i);A.DT_RowId=r+"-equal",A.exchangeRatio="",A[23]="{0}({1})".format(messages.cashview_equal_column.text,i),e(A,b),y.HandleZeroShowNA(A),q.UpdateRowData(A)}q.draw(),g()}function d(a,b){var c;if(a&&a.data){c={DT_RowId:r+"-"+a.account+"-"+a.currency};for(var d=0;d<m.length;d++)c[m[d].key]=a.data[m[d].key]}else{c={};for(var d=0;d<m.length;d++)c[m[d].key]=0}if(b){var e=a.currency||o.base_currency,f=o.get(e),g=o.get(b);if(f&&f.ratio&&g&&g.ratio)for(var h in c)if(!(t.indexOf(h)>=0)){var i=c[h]*(f.ratio/g.ratio);c[h]=i}}return c}function e(a,b){a&&b&&(IsMarginAccount(b)||(a.acceptValue=Number.NaN))}function f(a,b){if(a&&b){var c=o.get(a),d=o.get(b);if(c&&c.ratio&&d&&d.ratio)return c.ratio/d.ratio}return""}function g(){p.find("tr").each(function(){var a=$(this).attr("id");u.indexOf(a)>=0&&$(this).addClass("active")})}function h(a){return!a||a.length<=0?a:a.sort(function(a,b){return a[v]===o.base_currency?-1:1})}function i(a){if(a){var b=$("<button>",{type:"button","class":"btn btn-primary"}).append($("<span>",{"class":"fa fa-exchange"}));b.click(function(){x.show(o)}),a.find("button:last").after(b)}}var j,k,l,m,n,o,p,q,r="cashview",s=!1,t=["exchangeRatio"],u=["cashview-group","cashview-total","cashview-equal"],v="23",w={account:"",currency:"",equalCurrency:""},x=require("exchange-ratio");const y=require("util");exports.init=function(d,e,f,g){if(d&&d instanceof jQuery&&e&&0!=e.enable&&e.schema&&!(e.schema.length<=0)&&f&&g){j=d,l=e,m=e.schema,n=f,o=g;var h;n.on(function(){h?s&&c():h=setTimeout(function(){"multi"===o.currencyMode&&(a(m),b(),c(),k.translate(),c(),s=!0)},500)});var i=!1;PositionMgr.on(function(){s&&(i=!0)}),setInterval(function(){i&&c()},1e3)}}});