define(function(require,exports,module){function a(a){a=a||s;var b=!1;if(!i()){for(var c=n.find("[data-key]"),d=0;d<c.length;d++)$(c[d]).attr("data-key")===a&&(b=!0);b||(q.account_balance_list.push({account:q.current_account,base:r.base_currency,currency:a,data:{23:a},isDummy:!0}),f())}n.select(a)}function b(a){if(q&&q.account_balance_list&&!(q.account_balance_list.length<=0)){var b=j();if(a||v!==b){v=b,o&&o.length>0&&o.remove(),o=$("<div>");var g=k.parents(".panel").height()-70,h=.45*g,i=.5*g,r=$("<div>",{id:"account-balance-container1",style:"position: relative; height: {0}px".format(h)}),t=$("<div>",{id:"account-balance-container2",style:"position: relative; height: {0}px".format(i)});l=$("<table>",{border:"0",width:"100%"}),m=$("<table>",{border:"0",width:"100%"}),n=$("<div>",{"class":"text-right",id:"account-currency-dropdown-group",style:"margin:0px 0 5px 0"}),r.append(l),t.append(n).append($("<div>",{id:"account-balance-table-container2",style:"position: relative; height: {0}px".format(i-22)}).append(m));for(var u=$("<tr>").append($("<th>",{scrop:"col","class":"account-balance-header"})),x=0;x<p.mainSchema.length;x++){var y=p.mainSchema[x];u.append($("<th>",{scrop:"col","data-i18n":y.i18n||"",text:y.name,"class":"text-right account-balance-header"}))}l.append($("<tbody>").append(u));var z=$("<tbody>");l.append(z);for(var A=[],x=0;x<v;x++){var B=q.account_balance_list[x];if(B.account===q.current_account&&B.currency&&!B.isDummy){u=$("<tr>").append($("<th>",{scrop:"row"}).append(d(B.currency)));for(var C=0;C<p.mainSchema.length;C++){var y=p.mainSchema[C];u.append($("<td>",{"data-tag":y.key,"data-currency":B.currency,"class":"text-right text-primary"}))}A.push(u)}}A=e(A);for(var x=0;x<A.length;x++)z.append(A[x]);z=$("<tbody>");for(var x=0;x<p.schema.length;x++){var D=p.schema[x].key,E=p.schema[x].i18n||"account_balance_header_"+D,F=$("<small>").append($("<span>",{"class":"btn btn-info label label-info icon-btn-bank-balance-reload",text:messages.btn_reload.text})),u=$("<tr>"),G=$("<th>").append($("<span>",{scrop:"row","data-i18n":E,text:p.schema[x].name||""})),H=$("<td>",{"class":"text-right text-primary","data-tag":D});"bankBalance"==D?(G.append(F),u.append(G).append(H)):u.append(G).append(H),z.append(u)}m.append(z),o.append(r).append($("<hr />")).append(t).appendTo(k),s=s||"ALL",f(),r.perfectScrollbar(),t.find("#account-balance-table-container2").perfectScrollbar(),setTimeout(function(){r.perfectScrollbar("update"),t.find("#account-balance-table-container2").perfectScrollbar("update")},1e3),k.find("td").css("padding","4px").css("padding-right","8px"),k.translate(),n.on("change",function(a,b){current.currency=b,s=b,c()}),$(".icon-btn-bank-balance-reload").click(function(){w&&($.get($.getRandomUr("/iTrader/account/bankBalance"),function(){}),w=!1,setTimeout(function(){w=!0},1e3))})}}}function c(){l&&m&&(l.find("td").each(function(){var a=$(this).attr("data-currency"),b=$(this).attr("data-tag");if(a&&b){var c=q.get(q.current_account,a);c&&$(this).text($._format.amount(c[b]))}}),m.find("td").each(function(){var a=$(this).attr("data-tag");if(a){q.updateAcctInfo();var b;if(b=i()?q.get(q.current_account,null):q.get(q.current_account,s))if(isNaN(b[a]))$(this).text($._format.amount(b[a]));else{var c=s&&"ALL"!==s?s:r.base_currency,d=b[a]||0;if(i()){var e=r.get(c);e&&e.ratio&&(d/=e.ratio)}$(this).text($._format.amount(d||0)+"({0})".format(c))}}}))}function d(a){return $("<span>",{"class":"label label-info",style:"font-weight: normal; padding: 2px; width:30px",text:a})}function e(a){return!a||a.length<=0?a:a.sort(function(a,b){return"function"!=typeof a.text?"ALL"===a.key?-1:"ALL"===b.key?1:a.key===r.base_currency?-1:1:a.text()===r.base_currency?-1:1})}function f(){var a={name:{i18n:"column_currency",value:"currency"},data:[]};if("multi"===r.currencyMode){if(!q.account_balance_list)return;if(s=null,i())for(var b=0;b<r.currency_list.length;b++){var c=r.currency_list[b];h(a.data,c.currency)||a.data.push({key:c.currency,value:c.currency})}else for(var b=0;b<q.account_balance_list.length;b++){var d=q.account_balance_list[b];if(d.account==q.current_account){if(u.IsNeedToHideGroupBalance(r.currency_list)&&!d.currency){null==s&&(s=r.base_currency);continue}var f=d.currency||"ALL";h(a.data,f)||a.data.push({key:f,value:"ALL"===f?"{0}({1})".format(messages.ALL.text,r.base_currency):f})}}}a.data=e(a.data),n.CreateDrowdownGroup(a),g(n)}function g(a){if(a){var b=$("<button>",{type:"button","class":"btn btn-primary"}).append($("<span>",{"class":"fa fa-exchange"}));b.click(function(){t.show(r)}),a.find("button:last").after(b)}}function h(a,b){if(a)for(var c=0;c<a.length;c++)if(a[c]&&a[c].key===b)return!0}function i(){return"multi"===r.currencyMode&&p.consolidatedBalanceMode}function j(){var a=0;if(q&&q.account_balance_list)for(var b=0;b<q.account_balance_list.length;b++)q.account_balance_list[b].isDummy||a++;return a}var k,l,m,n,o,p,q,r,s,t=require("exchange-ratio"),u=require("util"),v=0,w=!0;exports.init=function(d,e,f,g){k=d,p=e,q=f,r=g,!k||!k instanceof jQuery||p&&q&&r&&(b(),c(),$("#nav_account").on("change",function(a,d){b(!0),n.select(s),c()}),q.on(function(){b(),c()}),PositionMgr.on(function(){c()}),$(document).on("ticket-added",function(b,d){d&&d[tags.currency]&&d[tags.currency]!==s&&(s=d[tags.currency],n.select(s),a(),c())}))}});