define(function(require,exports,module){function a(){var a={name:{i18n:"history_order_filter_type"},data:[]},c={name:{i18n:"history_order_filter_status"},data:[{key:"ALL",value:messages.ALL.text}]},d={name:{i18n:"history_order_filter_days"},data:[]},e=h.filter.type,f=h.filter.status,j=h.filter.days;if(e&&e.length>0){for(var k=0;k<e.length;k++)a.data.push({key:e[k],value:messages["history_type_"+e[k]].text});m.CreateDrowdownGroup(a)}else m.hide();for(var k=0;k<f.length;k++)c.data.push({key:f[k],value:$._map.status(f[k])});for(var p=0;p<j.length;p++)d.data.push({key:j[p],value:j[p]+messages.history_order_filter_days_before.text});n.CreateDrowdownGroup(c),o.CreateDrowdownGroup(d),n.on("change",function(a,b){var c=i.columns().dataSrc();if(c.length>0){var d=c.indexOf("5");if(d<=0)return;b="ALL"===b?"":$._map.status(b),i.column(d).search(b).draw()}}),m.on("change",function(a,c){q=c,b(),g.find(".history-table-wrapper").addClass("hidden"),$(i.table().container()).parent(".history-table-wrapper").removeClass("hidden"),l.trigger("click")})}function b(){if(h&&h.schema){if("order"!=q||r.order)if("cash"!=q||r.cash){if("fund"==q&&!r.fund){for(var a=[],b=0;b<h.fundSchema.length;b++){var d=h.fundSchema[b].key;"change"!=d&&"cancel"!=d&&a.push(h.fundSchema[b])}r.fund=k.fund.CreateDatatable({columnSchema:a,columnHeaderPrefix:"fundbook_header_",buttons:[{extend:"print",className:"btn-print"}],aoColumnDefs:[{className:"extra-row",targets:1}],getExtraRow:s.GetFundSwitchInfo})}}else r.cash=k.cash.CreateDatatable({columnSchema:h.cashSchema,columnHeaderPrefix:"cashbook_header_",buttons:[{extend:"print",className:"btn-print"}]});else r.order=k.order.CreateDatatable({columnSchema:h.schema,columnHeaderPrefix:"history_order_header_",buttons:[{extend:"print",className:"btn-print"}]});i=r[q],c(i),g.translate()}}function c(a){if(a){var b=$(a.table().container()),c=a.buttons().container();b.find(".dataTables_filter label input").attr("placeHolder",messages.datatables.sSearchPlaceHolder),c.addClass("pull-right"),c.find("a span, a i").remove(),c.find("a").append($("<i class='fa fa-lg fa-print text-muted'></i>")),c.appendTo(b.find(".dataTables_filter label")),$("#order-history-form").appendTo($(".col-sm-6:eq(0)",a.table().container()))}}function d(){l.find(".btn-icon-spinner").addClass("hidden"),l.find(".btn-icon-search").removeClass("hidden"),l.removeAttr("disabled")}function e(a){if(a&&a.data){if(i.clear(),a.data.length>0)for(var b=0;b<a.data.length;b++){var c=a.data[b];OrderMgr.parse(c),c.DT_RowId="orderhistory-"+c[tags.orderNo],i.UpdateRowData(c)}i.draw()}}function f(){p=m.find("span[data-key]").attr("data-key"),(!h.filter.type||h.filter.type.length<=0)&&(p="ALL");var a=o.find("span[data-key]").attr("data-key");return j.serialize()+"&days={0}&type={1}".format(a,p)}var g,h,i,j,k,l,m,n,o,p,q="order",r={},s=require("fundbook");exports.init=function(c,i){g=c,h=i,!g||!g instanceof jQuery||g.length<=0||!h||!h.schema||h.schema.length<=0||(j=$("#order-history-form"),l=$("#order-history-btn"),m=$("#order-history-types-dropdown-group"),n=$("#order-history-status-dropdown-group"),o=$("#order-history-days-dropdown-group"),k={order:g.find("#history-order-table"),fund:g.find("#history-fund-table"),cash:g.find("#history-cash-table")},l.click(function(){l.find(".btn-icon-spinner").removeClass("hidden"),l.find(".btn-icon-search").addClass("hidden"),l.attr("disabled","disabled"),$.ajax({type:"post",url:"/iTrader/order/history",data:f(),success:function(a){e(a),d(),n.find("li[style='display: none;'] a").trigger("click")},error:function(a){handleError(a),d()}})}),b(),a(),g.translate())}});