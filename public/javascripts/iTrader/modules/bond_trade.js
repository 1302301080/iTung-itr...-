define(function(require,exports,module){function a(a,d){n(),y=a,D.init($("#tab-bond-position"),d),u=$("#bond-buy-form"),v=$("#bond-sell-form"),C=$("#bond-select-submit"),k(),l(),h(),window.addEventListener("message",function(a){a.data&&"copy-symbol"===a.data.name&&("sell"===a.data.type&&$("[href='#tab-bond-sell']").tab("show"),$(".tab-pane.active .symbol-code").val(a.data.symbol).trigger("blur"))},!1),$(".bond-input-quantity").each(function(){$(this),$(this).InputFormat({format:function(a){return $._format.pattern(a,I)}})}),$(".bond-input-quantity-sell").InputPercentage({data:[10,20,50,100,0],total:0}),M.on("input",function(){$(this).val($(this).val().toUpperCase())}),M.blur(function(){B=!1;var a=$(this).val();o(a),$(this).parents("form").find(".bond-input-quantity-sell").attr("data-total",GetMaxSellSync(a)),$(this).parents("form").find(".bond-input-price").focus()}),M.keypress(function(a){13==a.keyCode&&$(this).trigger("blur")}),$("#bond-disclosure-accept-btn").on("click",function(){i(function(a){j(a)});var a=Number($(this).parents("[data-id]").attr("data-id"))+1;g(a)}),$("[step]").click(function(){var a=$(this).attr("step");$("[step={0}]".format(a)).hasClass("todo")||g(a)}),$("#search-bond-btn").click(function(){var a=$("#bond-search").val().toLowerCase().trim();m(a)}),$("#bond-search").keypress(function(a){var b=$("#bond-search").val().toLowerCase().trim();13==a.keyCode&&m(b)}),C.click(function(){var a=$(".symbol-code").val,b=$($(".tab-pane.active")[0]).find(".pending-submit-table tr");if(!(b.length<=1)){for(var d=1;d<b.length;d++)for(var e=$(b[d]).find("input"),f=0;f<e.length;f++){var a=$(e[f]).val();if(!a||"disabled"!==e.attr("disabled"))return $(e[f]).val(""),void $(e[f]).focus()}c()}}),A=$(".tab-pane.active"),$('a[data-toggle="tab"]').on("shown.bs.tab",function(a){var b=$(a.target).attr("href");"#tab-bond-sell"==b?(K=1,C.attr("class","btn btn-sm btn-danger pull-right")):(K=0,C.attr("class","btn btn-sm btn-success pull-right")),A=$(".tab-pane.active")}),$('input:radio[name="bond-order-action"]').change(function(a){var b=$(".selected-bond-list");b.empty(),$("#bond-table input").attr("checked",!1),"sell"==$(a.target).attr("value")?j(z,{hasPosition:!0}):j(z)}),$("#bond-next-btn").click(function(){var a=y.find('input[name="bond-order-action"]:checked ').val();"sell"==a?$("[href=#tab-bond-sell]").tab("show"):$("[href=#tab-bond-buy]").tab("show");for(var c=[],d=$(".selected-bond-list [data-symbol]"),e=0;e<d.length;e++){var f=$(d[e]),h=f.attr("data-symbol"),i=s(h)||{};c.push({0:h,3:t("BOND")?"0.00":void 0,23:i[23],symbolName:G.getFullSymbolName(i)})}var j=Number($(this).parents("[data-id]").attr("data-id"))+1;G.addNewPendSymbol(c,O,{newRowHandler:b,clear:!0}),g(j)}),y.find(".btn-submit").click(function(){var a=A.find(".symbol-code").val();if(a&&s(a)){var c=s(a);G.addNewPendSymbol([{0:c[0],3:A.find(".bond-input-price").val(),4:A.find(".bond-input-quantity").val(),23:c[23],symbolName:G.getFullSymbolName(c)}],O,{newRowHandler:b})}}),ExchangeMgr.on(function(){t("BOND")&&y.find(".bond-input-price").attr("disabled","disabled").val("0.00")}),$(document).translate()}function b(a){var b=A.find(".symbol-code");b.val()||b.val(a.attr("data-symbol")).trigger("blur"),a.find("[data-key=0]").click(function(){b.val($(this).parents("tr").attr("data-symbol")).trigger("blur")}),a.find("[data-key=4]").InputFormat({format:function(a){return $._format.pattern(a,I)}})}function c(){for(var a=$(".tab-pane.active"),b=a.find(".pending-submit-table"),c=a.find("input[name=side]").val(),e=b.find("tr"),f="",g="",h=1;h<e.length;h++){var i=$(e[h]).find("td"),j=$(i[1]).text(),k=$($(i[3]).find("input")).val(),l=$($(i[4]).find("input")).val();f+="symbol="+j+"&price="+k+"&quantity="+l+"&"}f=f+"_csrf="+L+"&type=multi&side="+c+"&productType=bond&cmd=add";var m=10;$("#bond-disclosure-panel").length>0&&(g=G.getDiscolsureCheckBox(m)),F.popupBondDisclaimer(function(a){a?E.submitCalcorder(f,{confirmBoxTitle:messages.order_confirmation_bond_title.text,addOrder:function(){showMessage({title:messages.order_confirmation_bond_title.text,buttonNameList:["submit","close"],message:p()+g,onshown:function(){G.checkboxAction()},callback:function(a,b){var c=a.attr("id");"btn-submit"===c&&$.ajax({type:"post",url:"/iTrader/order/submit",data:f,success:function(a){alertMessage({title:messages.dialog_information_title.text,message:q(a)})}}),b.close(),d()}})}}):d()})}function d(){initial_data.ticket.clearAfterSubmit&&e()}function e(){}function f(a){var b=["bond_step_disclosure","bond_step_select_bond","bond_step_trade_bond"];a||(b=["bond_step_select_bond","bond_step_trade_bond"]);for(var c=0;c<b.length;c++){var d,e=$("<div>",{"class":"wrap"});d=0==c?$("<div>",{"class":"current",step:c+1}):$("<div>",{"class":"todo",step:c+1}),d.append($("<label>").append($("<span>",{"class":"round",text:c+1})).append($("<span>",{"data-i18n":b[c]}))).append($("<i>",{"class":"triangle-right-bg"})).append($("<i>",{"class":"triangle-right"})),e.append(d),$(".bond-workFlow").append(e).translate()}}function g(a){for(var b=1;b<=$("[step]").length;b++){var c="[data-id ={0}]".format(b),d="[step={0}]".format(b);b!=a?(b<a?$(d).attr("class","finished"):$(d).attr("class","todo"),$(c).addClass("hidden")):($(c).removeClass("hidden"),$(d).attr("class","current")),$(d).hasClass("finished")?$(d).find(".round").html("<i class='sui-icon icon-pc-right'></i>"):$(d).find(".round").html("<i>{0}</i>".format(b))}}function h(){w=$("#bond-table"),x=w.CreateDatatable({columnSchema:N,searching:!1,paging:!1,scrollCollapse:!0,scrollY:!H&&"400px",order:[1,"asc"],aoColumnDefs:[{bSortable:!1,aTargets:[0]}]})}function i(a){return z?a(z):void $.get("/iTrader/Bond",function(b){z=b,a(b)})}function j(a,b){if(a){b=b||{},x.clear();for(var c=0;c<a.length;c++)if(a&&a[0]){var d=a[c],e=d[0].toLowerCase(),f=GetMaxSellSync(d[0]),g=d.symbolName.toLowerCase();b.query&&e.indexOf(b.query)<0&&g.indexOf(b.query)<0||b.hasPosition&&Number(f)<=0||(d.rowIndex="<input type='checkbox' data-symbol='{0}' data-symbolName = '{1}'>".format(d[0],g),d.availableQuantity=$._format.pattern(f,I),"undefined"==typeof d.oriCouponRate&&(d.oriCouponRate=d.couponRate),d.oriCouponRate&&(d.couponRate=$._format.pattern(100*d.oriCouponRate,"#,##0.########")+"%"),x.UpdateRowData(a[c]))}x.draw(),$(document).translate(),$("#bond-table input").change(function(){if($(this).get(0).checked){var a=$(this).attr("data-symbol"),b=$(this).attr("data-symbolName"),c=$("<a>",{"class":"symbol-code-tag",text:a,title:b,"data-symbol":a}).append($("<i>",{"class":"fa fa-times icon-btn-x"}));$(".selected-bond-list").append(c),c.find("i").click(function(){var a=$(this).parent().attr("data-symbol");$("#bond-table input[data-symbol={0}]".format(a)).attr("checked",!1),$(this).parent().remove()})}else{var a=$(this).attr("data-symbol");$(".selected-bond-list a[data-symbol={0}]".format(a)).remove()}})}}function k(){validateForm(u,{submitHandler:function(a){var b=$(a).find(".symbol-code").val();b&&J[b]&&F.popupBondDisclaimer(function(b){b&&E.submitCalcorder($(a).serialize()+"&account="+AccountMgr.current_account,{confirmBoxTitle:messages.order_confirmation_bond_title.text})})}})}function l(){validateForm(v,{submitHandler:function(a){var b=$(a).find(".symbol-code").val();b&&J[b]&&F.popupBondDisclaimer(function(b){b&&E.addNewPendSymbol($(a).serialize()+"&account="+AccountMgr.current_account)})}})}function m(a){a?j(z,{query:a}):j(z),$(".selected-bond-list [data-symbol]").each(function(){var a=$(this).attr("data-symbol");$("#bond-table input[data-symbol={0}]".format(a)).attr("checked",!0)})}function n(){$.get("/iTrader/bond/disclaimer?type=disclosure&temp="+(new Date).getTime(),function(a){var b;a&&a.url?(b=getMultiLanguageURL(a),$("#bond-disclosure-panel").attr("data-id","1"),$("#bond-list-panel").attr("data-id","2"),$("#bond-trade-panel").attr("data-id","3"),f(b),$.get(b,function(a){$("#bond-disclosure-content-div").html(a)})):($("#bond-list-panel").attr("data-id","1"),$("#bond-trade-panel").attr("data-id","2"),$("#bond-list-panel").removeClass("hidden"),f(b)),$("[step]").click(function(){var a=$(this).attr("step");$("[step={0}]".format(a)).hasClass("todo")||g(a)})})}function o(a){a&&r(a,function(a){if(!B){B=!0,IsOTCBond(a)||(a=null);var b=$(".tab-pane.active").find(".bond-info");if(b.empty(),!a)return void b.append($("<h4>",{text:messages.ticket_message_invalid_symbol.text}));var c=$("<h4>",{text:a.symbolName});a[3409]&&c.append($("<i>",{text:"Risk "+a[3409],"class":"highlight-tag",style:"margin-left: 10px;"})),"Y"==a[3602]&&c.append($("<i>",{text:"CIES ","class":"highlight-tag",style:"margin-left: 10px;"})),b.append(c);for(var d=$(".active [href=#tab-bond-sell]").length>0?1:0,e=F.getBondInfo(a,{side:d}),f=$("<td>").append($("<small>",{text:e.price?e.price.name+e.price.value:""})),g=$("<td>").append($("<small>",{text:e.currency?e.currency.name+e.currency.value:""})),h=$("<td>").append($("<small>",{text:e.cRate?e.cRate.name+e.cRate.value:""})),i=$("<td>").append($("<small>",{text:e.minAmt?e.minAmt.name+e.minAmt.value:""})),j=$("<td>").append($("<small>",{text:e.incrementalAmt?e.incrementalAmt.name+e.incrementalAmt.value:""})),k=$("<td>").append($("<small>",{text:e.sDate?e.sDate.name+(e.sDate.value?moment(e.sDate.value,"YYYYMMDD").format("YYYY/MM/DD"):""):""})),l=$("<td>").append($("<small>",{text:e.preCouDate?e.preCouDate.name+(e.preCouDate.value?moment(e.preCouDate.value,"YYYYMMDD").format("YYYY/MM/DD"):""):""})),m=$("<td>").append($("<small>",{text:e.txn?e.txn.name+$._format.percentage(e.txn.value,2):""})),n=$("<td>").append($("<small>",{text:e.minTxnAmount?e.minTxnAmount.name+$._format.amount(e.minTxnAmount.value):""})),o=$("<td>").append($("<small>",{text:e.availableQuantity?e.availableQuantity.name+e.availableQuantity.value:""})),p=G.getInfo([f,g,h,i,j,k,l,m,n,o]),q=$("<table>",{"class":"table table-condensed"}),r=0;r<p.length;r++)q.append(p[r]);b.append(q)}})}function p(){for(var a=[],b=A.find(".pending-submit-table tr[data-symbol]"),c=0;c<b.length;c++){var d=$(b[c]).attr("data-symbol");if(d){var e=s(d);a.push({0:d,23:e[23],3:$(b[c]).find("[data-key=3]").val(),4:$(b[c]).find("[data-key=4]").val(),symbolName:e.symbolName})}}var f=G.createTable(a,P,{side:1==K?1:0});return f?(f.find("table").addClass("dialog-table"),f.html()):""}function q(a){if(a){for(var b=(IsArray(a.error)?a.error:[]).concat(IsArray(a.data)?a.data:[]),c=0,d=0;d<b.length;d++){var e=b[d],f=s(e[0])||{},g="<i class='fa fa-check-circle text-success' style='margin-right:5px;'></i>";e._isErrorOrder&&(g="<i class='fa fa-times-circle text-danger' style='margin-right:5px;' title='{0}'></i>".format((getErrorMessage(e)||"").replace("<br />",""))),e[0]=g+e[0],e[23]=e[23]||f[23]||"",e[3]=$._format.pattern(e[3]*(f[1504]||1),"#,##0.00######"),e[4]=$._format.pattern(e[4],I),e.symbolName=f.symbolName||"",1!=e[11]&&5!=e[11]||(c=1)}var h=G.createTable(b,Q,{side:c});return h?(h.find("table").addClass("dialog-table"),h.html()):""}}function r(a,b){a?J[a]?b(J[a]):$.get("/iTrader/product?symbol="+a,function(c){var d=c.data;d?(J[a]=d,b(d)):b()}):b()}function s(a){if(a&&z)for(var b=0;b<z.length;b++)if(z[b][0]===a)return z[b]}function t(a){if(a)for(var b in ExchangeMgr.exchange_isPriceQuote)if(b===a&&ExchangeMgr.exchange_isPriceQuote[b])return!0}require("datatables");var u,v,w,x,y,z,A,B,C,D=require("bond-position"),E=require("ticket"),F=require("bond-ticket"),G=require("full-trade"),H=require("mobile").GetIsMobile(),I=initial_data.format.bond_unit,J={},K=0,L=$("input[name=_csrf]").val(),M=$(".symbol-code"),N=[{name:"#",key:"rowIndex","class":"prevent-popup-detail"},{name:"symbol",key:"0",i18n:"bond_symbol_code"},{name:"symbol name",key:"symbolName",i18n:"bond_name"},{name:"currency",key:"23",i18n:"column_currency"},{name:"couponRate",key:"couponRate",i18n:"column_coupon_rate","class":"text-right"},{name:"risk",key:"RPQLevel",i18n:"column_risk_level","class":"text-right"},{name:"cies",key:"CIESFlag",i18n:"column_CIES"},{name:"available quantity",key:"availableQuantity",i18n:"column_available_quantity","class":"text-right"}];initial_data.views.full_trade&&initial_data.views.full_trade.bond&&initial_data.views.full_trade.bond.listSchema&&(N=initial_data.views.full_trade.bond.listSchema);var O=[{name:"remove",key:"remove",type:"icon","class":"text-center pointer"},{name:"symbol",key:"0",text:messages.bond_symbol_code.text,"class":"pointer"},{name:"symbol name",key:"symbolName",text:messages.bond_name.text,mobile:!1},{name:"price",key:"3",type:"input",text:messages.bond_priceRate.text,"class":"text-right full-trade-input"},{name:"quantity",key:"4",type:"input",text:messages.bond_PAR.text,"class":"text-right full-trade-input"},{name:"currency",key:"23",text:messages.column_currency.text}],P=[{name:"symbol",key:"0",text:messages.bond_symbol_code.text,"class":"pointer"},{name:"symbol name",key:"symbolName",text:messages.bond_name.text,mobile:!1},{name:"price",key:"3",text:messages.bond_priceRate.text,"class":"text-right"},{name:"quantity",key:"4",text:messages.bond_PAR.text,"class":"text-right"},{name:"currency",key:"23",text:messages.column_currency.text}],Q=[{name:"symbol",key:"0",text:messages.bond_symbol_code.text,"class":"pointer"},{name:"symbol name",key:"symbolName",text:messages.bond_name.text,mobile:!1},{name:"price",key:"3",text:messages.bond_priceRate.text,"class":"text-right"},{name:"quantity",key:"4",text:messages.bond_PAR.text,"class":"text-right"},{name:"currency",key:"23",text:messages.column_currency.text},{name:"remark",key:"25",text:messages.column_remark.text}];$(document).on("page",function(a,b){"shown"===b&&x&&x.draw()}),exports.init=a});