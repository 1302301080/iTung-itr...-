define(function(require,exports,module){function a(){o=$("#ipo-info-table"),p=$("#ipo-qty-amount-table"),q=$("#ipo-symbol-code").val(),r=$("#ipo-announce-code").val(),t=$("#ipo-select-quantity"),u=$("#ipo-checkbox-margin-ratio"),v=$("#ipo-input-margin-ratio"),w=$("#ipo-error-message"),x=$("#login-type").val(),y=$("#ipo-login-id").val(),$("[data-format=date]").each(function(){var a=moment($(this).text(),"YYYY-MM-DD").format(n.format.date);$(this).text(a)}),$("#app-account-exploer-btn").click(function(){B.popup({callback:function(a){s.val(a)}})})}function b(b){b=b||{},n=b.configData,B.init(n),$.get("/eipo/data/ipo?symbol={0}&announce={1}".format(b.symbolCode,b.announceCode),function(c){if(c){a();var d=c[1514],f="0"!=c[1505];z=Number(c[1506]),C.convertIPOData(c,n.schema.ipo,n.format);for(var h=["0","symbolName","24","1506","offerPrice","23","1502","1503","1513","1504"],i=0;i<h.length;i++){var j=g(h[i]),k="",l=c[h[i]];3===i&&(k="column-max-loan-ratio",l=f?C.getMarginRatio(1-Number(l),n.decimal,!0)||0:messages.NotApplicableValue.text),j&&(k=j.i18n),o.append($("<tr>").append($("<td>",{"data-i18n":k,style:"width:140px;"})).append($("<td>",{text:l,title:"symbolName"===h[i]?l:""})))}if(c[74])for(var m=c[74].split(","),i=0;i<m.length;i++){var q=m[i].split("=");if(2===q.length){var r=D.formatWithPattern(q[0],n.format.decimal);t.append("<option>{0}</option>".format(q[0]));var w=D.formatWithPattern(q[1],n.format.price);p.append($("<tr>").append($("<td>",{text:r,"class":"click-qty pointer"})).append($("<td>",{text:w})))}}}d&&d>0&&($("#ipo-margin-ratio-group").removeClass("hidden"),f&&z>0&&z<1?v.val(C.getMarginRatio(1-z,n.decimal)):(u.attr("disabled","disabled"),v.attr("disabled","disabled").val(messages.NotApplicableValue.text)));var A=c[1509],B=c[1510];A&&$.trim(A)&&(A=0==A.indexOf("http")?A:"http://"+A,$("#ipo-prospectus").append($("<a>",{href:A,target:"_blank",style:"margin-left:10px;text-decoration:underline",text:messages.eipo["ipo-prospectus"].text})).append()),B&&$.trim(B)&&(B=0==B.indexOf("http")?B:"http://"+B,$("#ipo-prospectus").append($("<a>",{href:B,target:"_blank",style:"margin-left:10px;text-decoration:underline",text:messages.eipo["ipo-prospectus-cn"].text}))),"1"===x?(s=$("#ipo-acct-input-account"),s.val(y),s.attr("disabled","disabled")):s=$("#ipo-user-input-account"),C.handleAcctUserUI(),C.upperCaseInput(),$(".scrollbar").perfectScrollbar(),$(".click-qty").click(function(){var a=$(this).text().replace(/,/g,"");isNaN(a)||(t.val(a),e())}),t.change(function(a){e()}),u.change(function(){this.checked?v.removeAttr("disabled"):v.attr("disabled","disabled"),e()}),v.change(function(){e()}),v.keypress(function(a){13==a.keyCode&&(e(),a.stopPropagation())}),s.change(function(){e()}),b.container.translate("eipo"),b.container.format(),e()})}function c(b){b=b||{},n=b.configData,a(),t.change(function(a){e()}),b.container.translate("eipo"),b.container.format()}function d(b){b=b||{},n=b.configData,a(),b.container.translate("eipo"),b.container.format()}function e(){if(t){var a=m();if(a)return void w.text(a);w.text("");var b=f();if(b.account&&b.quantity){$(".calc-info").text("");var c=t.val();isNaN(c)||(A=c,h(function(a,b){l(a,b)}))}}}function f(){return{symbol:q,announceCode:r,account:s?s.val():$("#change-order-account").text(),quantity:t.val(),marginRate:u.is(":checked")?v.val():"",orderNo:$("#ipo-orderNo").text(),newQuantity:A,_csrf:$("[name=_csrf]").val()}}function g(a){for(var b=0;b<n.schema.ipo.length;b++)if(n.schema.ipo[b].key==a)return n.schema.ipo[b]}function h(a){a=a||function(){},$.ajax({type:"post",url:"/eipo/calc",data:f(),success:function(b){if(b)if(b.err)a(b.err);else{var c=b.data,d=c[3]-c[1601]+c[1602];a(null,{requiredAmount:D.formatWithPattern(c[3],n.format.price),cashAmount:D.formatWithPattern(d,n.format.price),loanAmount:D.formatWithPattern(c[1601],n.format.price),estimatedInterest:D.formatWithPattern(c[1602],n.format.price)})}},error:function(a){C.alertError(C.getErrorMessage(a))}})}function i(a){var b=m();if(b)return void w.text(b);var c=f();c.account&&c.quantity&&$.ajax({type:"post",url:"/eipo/apply",data:f(),success:function(b){b&&b.err?a(b,null):a(null,b)},error:function(b){a(b,null)}})}function j(a){isNaN(t.val())||$.ajax({type:"post",url:"/eipo/change",data:f(),success:function(b){b&&b.err?a(b,null):a(null,b)},error:function(b){a(b,null)}})}function k(a){$.ajax({type:"post",url:"/eipo/cancel",data:f(),success:function(b){b&&b.err?a(b,null):a(null,b)},error:function(b){a(b,data)}})}function l(a,b){w.text(""),a?w.text(C.getErrorMessage(a)):b&&($("#ipo-total-required-amount").text(b.requiredAmount),$("#ipo-cash-amount").text(b.cashAmount),$("#ipo-loan-amount").text(b.loanAmount),$("#ipo-estimated-interest").text(b.estimatedInterest))}function m(){if(!v.attr("disabled")){var a=Number(v.val());if(a<0||100-a<100*z)return messages.error.IncorrectMargin}}require("datatables");var n,o,p,q,r,s,t,u,v,w,x,y,z,A,B=require("eipo-accountExploer"),C=require("eipo-utility"),D=require("format");require("eipo-socket"),$("html").attr("lang");exports.initApplicationForm=b,exports.initChangeOrderForm=c,exports.initCancelOrderForm=d,exports.calc=h,exports.add=i,exports.change=j,exports.cancel=k});