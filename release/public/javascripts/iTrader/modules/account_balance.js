define(function(require,exports,module){function a(){var a=l.parents(".panel").height()-90;m=$("<div>"),n=$("<div>",{"class":"text-right",id:"account-currency-dropdown-group",style:"margin:-5px 0 5px 0"});for(var c=$("<ul>",{"class":"list-group",id:"account-banlance-ul",style:"position: relative; height:{0}px".format(a)}),d=0;d<r.length;d++){var e=r[d].key,f=r[d].i18n||"account_balance_header_"+e;if("bankBalance"==e)c.append("<li class='list-group-item'><b><span data-i18n='"+f+"'></span><small><span class='btn btn-info label label-info icon-btn-bank-balance-reload'>"+messages.btn_reload.text+"</span></small></b><span class='pull-right text-primary account_balance_list' data-format='amount' data-tag='"+e+"'></span></li>");else{if("CB"===r[d].alias){var g=$("<li id='multi-currency-cb' class='list-group-item' aria-expanded='true'><b ><span data-i18n='"+f+"'></span></b><span class='pull-right text-primary account_balance_list' data-format='amount' data-tag='"+e+"'></span></li>");k()||g.find(".account_balance_list").remove()}else var g=$("<li class='list-group-item'><b data-i18n='"+f+"'></b><span class='pull-right text-primary account_balance_list' data-format='amount' data-tag='"+e+"'></span></li>");c.append(g)}}c.perfectScrollbar(),m.append(n).append(c),l.append(m),l.translate(),n.on("change",function(a,c){current.currency=c,u=c,b()}),setTimeout(function(){c.perfectScrollbar("update")},3e3)}function b(){p.updateAcctInfo();var a,b=p.current_account,c=1;if(i()){a=p.get(b,null);var d=q.get(u);d&&d.ratio&&(c=d.ratio)}else a=g()&&"CNY"===u?p.get(b+initial_data.CNYAcctSuffix,"CNY"):p.get(b,u);a&&(t.HandleZeroShowNA(a),$(".account_balance_list").each(function(){var b=$(this).attr("data-tag");if(a&&a[b])if("string"==typeof a[b]&&isNaN(a[b]))$(this).text(a[b]);else{var d=a[b]/c;$(this).text(d||0)}else a&&isNaN(a[b])?$(this).text(a[b]):$(this).text(0)}),m.format())}function c(){if(j()){var a=$("#multi-currency-cb");x||(a.click(function(a){$(a.target).parent("div").hasClass("multi-cash-balance")||("true"==$(this).attr("aria-expanded")?($(this).find(".multi-cash-balance").hide(),$(this).attr("aria-expanded",!1)):($(this).find(".multi-cash-balance").show(),$(this).attr("aria-expanded",!0)))}),x=!0),a.find(".multi-cash-balance").remove();var b=$("<div class='multi-cash-balance'>").append("<hr style='width: 100%;' />");for(var c in p.account_multi_currency_CB){var d=$._format.amount(p.account_multi_currency_CB[c]||0);b.append($("<p>").append("<span>{0}</span>".format(c)).append("<span class='pull-right'>{0}</span>".format(d)))}a.find(".fa-list").length<=0&&a.find("b").prepend("<i class='fa fa-list icon-margin'></i>"),a.css("cursor","pointer"),a.append(b),"false"==a.attr("aria-expanded")&&b.hide()}}function d(){if(initial_data.views.trade.account_balance.disableCurrencyConversion)return u=q.base_currency,void $("#account-balance-remark").html(messages.account_balance_remark.html);var a={name:{i18n:"column_currency",value:"currency"},data:[]};u&&a.data.push({key:u,value:u});var b=p.current_account;if("multi"===q.currencyMode){if(!p.account_balance_list)return;if(i())for(var c=0;c<q.currency_list.length;c++){var d=q.currency_list[c];h(a.data,d.currency)||a.data.push({key:d.currency,value:d.currency})}else{var j=_.filter(p.account_balance_list,function(a){return a.account==b});if(b==v.account&&j.length==v.count)return;for(var c=0;c<j.length;c++){var k=j[c];if(!t.IsNeedToHideGroupBalance(q.currency_list)||k.currency){var l=k.currency||"ALL";h(a.data,l)||a.data.push({key:l,value:"ALL"===l?"{0}({1})".format(messages.ALL.text,q.base_currency):l})}else u||(u=q.base_currency)}}}else{if(!q.currency_list)return;var m;if(g()&&(a.data=[{key:q.base_currency,value:q.base_currency},{key:"CNY",value:"CNY"}]),g())m=2;else{for(var c=0;c<q.currency_list.length;c++){var o=q.currency_list[c].currency;h(a.data,o)||a.data.push({key:o,value:o})}m=q.currency_list.length}if(b==v.account&&m==v.count)return;u=q.base_currency}v={account:b,count:a.data.length},a.data=f(a.data),n.CreateDrowdownGroup(a),e(n)}function e(a){if(a){var b=$("<button>",{type:"button","class":"btn btn-primary"}).append($("<span>",{"class":"fa fa-exchange"}));b.click(function(){s.show(q)}),a.find("button:last").after(b)}}function f(a){return!a||a.length<=0?a:a.sort(function(a,b){return a.key===u?-1:b.key===u?1:"ALL"===a.key?-1:"ALL"===b.key?1:a.key===q.base_currency?-1:(b.key===q.base_currency,1)})}function g(){if(initial_data&&initial_data.CNYAcctSuffix)return!0}function h(a,b){if(a)for(var c=0;c<a.length;c++)if(a[c]&&a[c].key===b)return!0}function i(){return"multi"===q.currencyMode&&o.consolidatedBalanceMode}function j(){return!(!p.account_multi_currency_CB||$.isEmptyObject(p.account_multi_currency_CB))}function k(){return o.showConsolidatedCB!==!1}var l,m,n,o,p,q,r=[],s=require("exchange-ratio"),t=require("util"),u=null,v={},w=!0,x=!1;exports.init=function(e,f,g,h){if(l=e,o=f,p=g,q=h,l&&l instanceof jQuery&&o&&p&&q){r=o.schema,a(),b(),$("#nav_account").on("change",function(a,c){d(),b()}),AccountMgr.on(function(a){d(),b(),a.account_multi_currency_CB&&c()}),PositionMgr.on(function(){b()}),$(document).on("ticket-added",function(a,b){b&&b[tags.currency]&&b[tags.currency]!==u&&n.select(b[23])}),$(".icon-btn-bank-balance-reload").click(function(){w&&($.get($.getRandomUrl("/iTrader/account/bankBalance"),function(){}),w=!1,setTimeout(function(){w=!0},1e3))});var i=5,j=function(){c(),i--,i<=0&&clearInterval(k)},k=setInterval(j,2e3)}}});